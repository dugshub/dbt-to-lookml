version: 2

semantic_models:
  - name: facility_dimension
    description: |
      Consolidated facility dimension semantic model sourced from wide entity table `redshift_gold.facilities`.
      Provides comprehensive facility attributes by combining dim_facility and dim_canonical_facility data,
      including location coordinates, addresses, market segmentation, and operational metadata for
      geographic and facility-level analytics.

    model: ref('facilities')

    defaults:
      agg_time_dimension: created_at

    entities:
      - name: facility
        type: primary
        expr: facility_sk
      - name: canonical_facility
        type: foreign
        expr: canonical_facility_sk

    dimensions:
      # ===== TIME DIMENSIONS =====
      - name: created_at
        label: "Facility Created"
        description: "Timestamp when the facility was first created in the system (primary time dimension for aggregations)."
        type: time
        type_params:
          time_granularity: day
        expr: facility_created_at
        config:
          meta:
            subject: "Date Dimensions"
            category: "Facility Created (UTC)"
            hidden: true

      - name: canonical_facility_created_at
        label: "Canonical Facility Created"
        description: "Timestamp when the canonical facility record was first created in the system."
        type: time
        type_params:
          time_granularity: day
        expr: canonical_facility_created_at
        config:
          meta:
            subject: "Date Dimensions"
            category: "Canonical Facility Created (UTC)"
            hidden: true

      # ===== IDENTIFIERS =====
      - name: facility_id
        label: "Facility ID"
        description: "Natural key identifier for the parking facility."
        type: categorical
        expr: facility_id
        config:
          meta:
            subject: "Identifiers"
            category: "Facility"
            bi_field: true

      - name: canonical_facility_id
        label: "Canonical Facility ID"
        description: "Canonical identifier grouping related facilities (same physical location with different configurations)."
        type: categorical
        expr: canonical_facility_id
        config:
          meta:
            subject: "Identifiers"
            category: "Facility"
            bi_field: true

      - name: operator_id
        label: "Operator ID"
        description: "Identifier for the facility operator/partner."
        type: categorical
        expr: operator_id
        config:
          meta:
            subject: "Identifiers"
            category: "Partner"
            bi_field: true

      - name: facility_external_id
        label: "Facility External ID"
        description: "External system identifier for the canonical facility."
        type: categorical
        expr: facility_external_id
        config:
          meta:
            subject: "Identifiers"
            category: "Facility"
            bi_field: false

      - name: facility_salesforce_id
        label: "Facility Salesforce ID"
        description: "Salesforce identifier for the canonical facility."
        type: categorical
        expr: facility_salesforce_id
        config:
          meta:
            subject: "Identifiers"
            category: "Facility"
            bi_field: false

      # ===== CORE ATTRIBUTES =====
      - name: facility_title
        label: "Facility Title"
        description: "Customer-facing name of the parking facility as displayed in search results and reservations."
        type: categorical
        expr: facility_title
        config:
          meta:
            subject: "Facility"
            category: "Identity"
            bi_field: true

      - name: canonical_facility_name
        label: "Canonical Facility Name"
        description: "Standardized name for the canonical facility, used for grouping and reporting across related facilities."
        type: categorical
        expr: canonical_facility_name
        config:
          meta:
            subject: "Facility"
            category: "Identity"
            bi_field: true

      - name: base_title
        label: "Base Title"
        description: "Standardized/canonical name for the facility, used for deduplication and facility grouping."
        type: categorical
        expr: facility_title
        config:
          meta:
            subject: "Facility"
            category: "Identity"
            bi_field: false

      - name: facility_type
        label: "Facility Type"
        description: "Classification of the parking facility (garage, lot, personal_spot, under_el, valet_stand)."
        type: categorical
        expr: facility_type
        config:
          meta:
            subject: "Facility"
            category: "Type"
            bi_field: true

      - name: facility_status
        label: "Facility Status"
        description: "Current operational status of the facility (on_sales_allowed, on_sales_not_allowed, off, archived)."
        type: categorical
        expr: facility_status
        config:
          meta:
            subject: "Facility"
            category: "Status"
            bi_field: true

      # ===== LOCATION DIMENSIONS =====
      - name: canonical_street_address
        label: "Street Address"
        description: "Canonical street address of the parking facility."
        type: categorical
        expr: canonical_street_address
        config:
          meta:
            subject: "Geography"
            category: "Canonical Address"
            bi_field: true

      - name: canonical_city
        label: "City"
        description: "City where the parking facility is located."
        type: categorical
        expr: canonical_city
        config:
          meta:
            subject: "Geography"
            category: "Canonical Address"
            bi_field: true

      - name: canonical_state
        label: "State"
        description: "State/province where the parking facility is located."
        type: categorical
        expr: canonical_state
        config:
          meta:
            subject: "Geography"
            category: "Canonical Address"
            bi_field: true

      - name: canonical_zipcode
        label: "Zipcode"
        description: "Postal/ZIP code for the parking facility location."
        type: categorical
        expr: canonical_zipcode
        config:
          meta:
            subject: "Geography"
            category: "Canonical Address"
            bi_field: true

      - name: location_lat
        label: "Latitude"
        description: "Geographic latitude coordinate of the facility location."
        type: categorical
        expr: location_lat
        config:
          meta:
            subject: "Geography"
            category: "Coordinates"
            bi_field: true
            note: "Use for map visualizations and distance calculations"

      - name: location_lon
        label: "Longitude"
        description: "Geographic longitude coordinate of the facility location."
        type: categorical
        expr: location_lon
        config:
          meta:
            subject: "Geography"
            category: "Coordinates"
            bi_field: true
            note: "Use for map visualizations and distance calculations"

      # ===== MARKET DIMENSIONS =====
      - name: reporting_market
        label: "SpotHero Metro Area"
        description: |
          SpotHero metropolitan area designation for the facility. Represents the broader
          metro area (e.g., "Chicago", "New York") used for in-app search categorization
          and market grouping. For actual physical location, reference canonical facility coordinates.
        type: categorical
        expr: spothero_metro_area
        config:
          meta:
            subject: "Geography"
            category: "Reporting Market"
            bi_field: true

      # ===== OPERATIONAL ATTRIBUTES =====
      - name: is_active
        label: "Is Active"
        description: "Flag indicating if the facility is currently accepting reservations (TRUE when status is on_sales_allowed or on_direct_link_only)."
        type: categorical
        expr: is_active
        config:
          meta:
            subject: "Facility"
            category: "Status"
            bi_field: true

      - name: is_new_store
        label: "Is New Store"
        description: "Flag indicating if this is a newly added facility (within the last 90 days of initial setup)."
        type: categorical
        expr: case when facility_created_at >= dateadd(day, -90, current_date) then true else false end
        config:
          meta:
            subject: "Facility"
            category: "Status"
            bi_field: true

      - name: timezone
        label: "Facility Timezone"
        description: "IANA timezone identifier for the facility location (e.g., 'America/Chicago')."
        type: categorical
        expr: timezone
        config:
          meta:
            subject: "Facility"
            category: "Attributes"
            bi_field: true

      - name: currency_type
        label: "Currency Type"
        description: "Currency code for pricing at this facility (e.g., 'USD', 'CAD')."
        type: categorical
        expr: currency_type
        config:
          meta:
            subject: "Facility"
            category: "Attributes"
            bi_field: true

    measures:
      - name: parking_spot_count
        label: "Parking Spot Count"
        description: "Distinct count of unique parking facilities (by facility_id). Represents the total number of individual parking locations in the network."
        agg: count_distinct
        expr: facility_id
        config:
          meta:
            subject: "Facilities"
            category: "Metrics"
            hidden: true
            note: "Base measure for facility metrics"
