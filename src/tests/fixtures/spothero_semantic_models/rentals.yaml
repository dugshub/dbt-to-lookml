version: 2

semantic_models:
  - name: rentals
    description: |
      Consolidated rental semantic model sourced from wide entity table `redshift_gold.rentals`.
      Transaction-level data combining fact, segmentation, and attribute dimensions for comprehensive rental analytics.

      This model consolidates:
      - Fact data: revenue, counts, timing from fct_rental
      - Segmentation: Monthly/Event/Airport/Transient classifications from dim_rental_segmentation
      - Attributes: payment methods, booking sources, device categories from dim_rentals

      One-stop model for all rental metrics and dimensions.
    model: ref('rentals')
    defaults:
      agg_time_dimension: created_at

    entities:
      - name: rental
        type: primary
        expr: unique_rental_sk
      - name: facility
        type: foreign
        expr: facility_sk
      - name: canonical_facility
        type: foreign
        expr: canonical_facility_sk
      - name: search
        type: foreign
        expr: search_sk
      - name: session
        type: foreign
        expr: session_sk

    dimensions:
      # ===== TIME DIMENSIONS (UTC) =====
      - name: created_at
        label: "Rental Created"
        description: "Timestamp when the rental was created (primary time dimension for aggregations)."
        type: time
        type_params:
          time_granularity: day
        expr: rental_created_at_utc
        config:
          meta:
            subject: "Date Dimensions"
            category: "Rental Created"
            bi_field: true

      - name: starts_at
        label: "Rental Start"
        description: "Timestamp when the parking period begins."
        type: time
        type_params:
          time_granularity: hour
        expr: rental_starts_at_utc
        config:
          meta:
            subject: "Date Dimensions"
            category: "Rental Start"
            bi_field: true

      - name: ends_at
        label: "Rental End"
        description: "Timestamp when the parking period ends."
        type: time
        type_params:
          time_granularity: hour
        expr: rental_ends_at_utc
        config:
          meta:
            subject: "Date Dimensions"
            category: "Rental End"
            bi_field: true

      - name: updated_at
        label: "Rental Updated"
        description: "Last modification timestamp for the rental record."
        type: time
        type_params:
          time_granularity: day
        expr: rental_updated_at_utc
        config:
          meta:
            subject: "Date Dimensions"
            category: "Rental Updated (UTC)"
            hidden: true

      # ===== TIME DIMENSIONS (LOCAL) =====
      - name: created_at_local
        label: "Rental Created (Local)"
        description: "Timestamp when the rental was created in facility's local timezone."
        type: time
        type_params:
          time_granularity: day
        expr: rental_created_at_local
        config:
          meta:
            subject: "Date Dimensions"
            category: "Rental Created"
            bi_field: true
            note: "Local timezone for time-of-day analysis"

      - name: starts_at_local
        label: "Rental Start (Local)"
        description: "Timestamp when parking begins in facility's local timezone."
        type: time
        type_params:
          time_granularity: hour
        expr: rental_starts_at_local
        config:
          meta:
            subject: "Date Dimensions"
            category: "Rental Start"
            bi_field: true
            note: "Local timezone for time-of-day analysis (commuter hours, evening events, etc.)"

      - name: ends_at_local
        label: "Rental End (Local)"
        description: "Timestamp when parking ends in facility's local timezone."
        type: time
        type_params:
          time_granularity: hour
        expr: rental_ends_at_local
        config:
          meta:
            subject: "Date Dimensions"
            category: "Rental End"
            bi_field: true
            note: "Local timezone for time-of-day analysis"

      # ===== IDENTIFIERS =====
      - name: rental_id
        label: "Rental ID"
        description: "Natural key identifier for the rental transaction."
        type: categorical
        expr: rental_id
        config:
          meta:
            subject: "Identifiers"
            category: "Rental"
            bi_field: true

      - name: rental_recurrence_id
        label: "Rental Recurrence ID"
        description: "Identifier for monthly rental recurrences. NULL for one-time rentals."
        type: categorical
        expr: rental_recurrence_id
        config:
          meta:
            subject: "Identifiers"
            category: "Subscription"
            bi_field: true

      - name: facility_id
        label: "Facility ID"
        description: "Natural key identifier for the parking facility."
        type: categorical
        expr: facility_id
        config:
          meta:
            subject: "Identifiers"
            category: "Facility"
            bi_field: true

      - name: canonical_facility_id
        label: "Canonical Facility ID"
        description: "Canonical facility identifier for facility-level aggregations and rollups. Groups related facilities (e.g., same physical location with different configurations)."
        type: categorical
        expr: canonical_facility_id
        config:
          meta:
            subject: "Identifiers"
            category: "Facility"
            bi_field: true

      - name: renter_id
        label: "Renter ID"
        description: "Natural key identifier for the customer/renter."
        type: categorical
        expr: renter_id
        config:
          meta:
            subject: "Identifiers"
            category: "Customer"
            bi_field: true

      - name: monthly_subscription_id
        label: "Monthly Subscription ID"
        description: "Identifier for monthly subscription if applicable. NULL for non-subscription rentals."
        type: categorical
        expr: monthly_subscription_id
        config:
          meta:
            subject: "Identifiers"
            category: "Subscription"
            bi_field: true

      - name: event_id
        label: "Event ID"
        description: "Identifier for associated event (concerts, sports, festivals). NULL for non-event rentals."
        type: categorical
        expr: event_id
        config:
          meta:
            subject: "Identifiers"
            category: "Event"
            bi_field: true

      - name: affiliate_id
        label: "Affiliate ID"
        description: "Identifier for affiliate partner. NULL if not from affiliate channel."
        type: categorical
        expr: affiliate_id
        config:
          meta:
            subject: "Identifiers"
            category: "Partner"
            bi_field: true

      - name: profile_id
        label: "Profile ID"
        description: "User profile identifier."
        type: categorical
        expr: profile_id
        config:
          meta:
            subject: "Identifiers"
            category: "Customer"
            bi_field: true

      - name: partner_id
        label: "Partner ID"
        description: "Business partner identifier."
        type: categorical
        expr: partner_id
        config:
          meta:
            subject: "Identifiers"
            category: "Partner"
            bi_field: true

      - name: rule_id
        label: "Pricing Rule ID"
        description: "Identifier for the pricing rule applied to this rental."
        type: categorical
        expr: rule_id
        config:
          meta:
            subject: "Identifiers"
            category: "Pricing"
            bi_field: true

      - name: search_id
        label: "Search ID"
        description: "Identifier for the search session that led to this rental."
        type: categorical
        expr: search_id
        config:
          meta:
            subject: "Identifiers"
            category: "User Journey"
            bi_field: true

      - name: action_id
        label: "Action ID"
        description: "ID representing a returned set of results from an action within a Search (defined by the initial Search Parameters). This may be the result of map movements, pans, zooms or another search."
        type: categorical
        expr: action_id
        config:
          meta:
            subject: "Identifiers"
            category: "User Journey"
            bi_field: true

      # ===== RENTAL STATUS DIMENSIONS =====
      - name: reservation_status
        label: "Reservation Status"
        description: "Rental reservation lifecycle status (confirmed, cancelled, completed, no_show, etc.)."
        type: categorical
        expr: rental_reservation_status
        config:
          meta:
            subject: "Reservation"
            category: "Status"
            bi_field: true

      - name: payment_status
        label: "Payment Status"
        description: "Rental payment status category (paid, pending, failed, refunded, etc.)."
        type: categorical
        expr: rental_payment_status
        config:
          meta:
            subject: "Reservation"
            category: "Status"
            bi_field: true

      - name: transaction_type
        label: "Rental Order Status"
        description: "Order fulfillment status indicating what happened to the rental order (completed, cancelled, refunded, failed, disputed, other). This is the primary dimension for filtering business metrics - use 'completed' for revenue and count metrics."
        type: categorical
        expr: rental_event_type
        config:
          meta:
            subject: "Reservation"
            category: "Status"
            bi_field: true

      # ===== RENTAL SEGMENTATION DIMENSIONS =====
      - name: is_monthly_rental
        label: "Is Monthly Rental"
        description: "Boolean indicator for rentals with monthly pricing rule type (subscription-based parking)."
        type: categorical
        expr: is_monthly_rental
        config:
          meta:
            subject: "Reservation"
            category: "Segment"
            bi_field: true

      - name: is_event_rental
        label: "Is Event Rental"
        description: "Boolean indicator for event-associated rentals (concerts, sports games, festivals, etc.)."
        type: categorical
        expr: is_event_rental
        config:
          meta:
            subject: "Reservation"
            category: "Segment"
            bi_field: true

      - name: is_airport_rental
        label: "Is Airport Rental"
        description: "Boolean indicator for airport facility rentals with 24+ hour duration."
        type: categorical
        expr: is_airport_rental
        config:
          meta:
            subject: "Reservation"
            category: "Segment"
            bi_field: true

      - name: is_first_completed_rental
        label: "Is First Completed Rental"
        description: "Flag indicating if this was the renter's first completed rental transaction. Excludes cancelled or refunded rentals."
        type: categorical
        expr: is_first_completed_rental
        config:
          meta:
            subject: "Reservation"
            category: "Customer Type"
            bi_field: true

      - name: rental_segment_rollup
        label: "Primary Rental Segment"
        description: "Hierarchical rental categorization with strict precedence (Monthly > Event > Airport > Transient). Primary segmentation dimension for reporting."
        type: categorical
        expr: rental_segment_rollup
        config:
          meta:
            subject: "Reservation"
            category: "Segment"
            bi_field: true

      - name: rental_segment
        label: "Rental Segment"
        description: "Granular rental segment categorization. For Monthly, Event, and Airport rentals, matches rental_segment_rollup. For Transient rentals, provides temporal segment detail (Weekday, Weekend, Daily, etc.)."
        type: categorical
        expr: rental_segment
        config:
          meta:
            subject: "Reservation"
            category: "Segment"
            bi_field: true

      - name: temporal_segment
        label: "Temporal Segment"
        description: "Time-based rental pattern classification (Commuter, Short-term Weekday, Weekday PM, Weekend Day, Multiday, Other)."
        type: categorical
        expr: temporal_segment
        config:
          meta:
            subject: "Reservation"
            category: "Temporal Pattern"
            bi_field: true

      - name: rental_length_minutes
        label: "Rental Length (Minutes)"
        description: "Duration of rental period in minutes."
        type: categorical
        expr: rental_length_minutes
        config:
          meta:
            subject: "Reservation"
            category: "Duration"
            bi_field: true

      # ===== RENTAL ATTRIBUTES DIMENSIONS =====
      - name: payment_type
        label: "Payment Type"
        description: "Payment method used for the rental (credit card, PayPal, Apple Pay, etc.)."
        type: categorical
        expr: payment_type_title
        config:
          meta:
            subject: "Reservation"
            category: "Payment"
            bi_field: true

      - name: rental_source
        label: "Rental Source"
        description: "Channel or platform where the rental was booked (SpotHero Web, SpotHero iOS, SpotHero Android, Partner API, etc.)."
        type: categorical
        expr: rental_source_title
        config:
          meta:
            subject: "Reservation"
            category: "Channel"
            bi_field: true

      - name: rental_source_application
        label: "Rental Source Application"
        description: "Specific application used for booking (mobile app version, web browser, API client, etc.)."
        type: categorical
        expr: rental_source_application
        config:
          meta:
            subject: "Reservation"
            category: "Channel"
            bi_field: true

      - name: source_device_category
        label: "Source Device Category"
        description: "Device category reported for the booking source (Desktop, Mobile, Tablet)."
        type: categorical
        expr: rental_source_device_category
        config:
          meta:
            subject: "Reservation"
            category: "Channel"
            bi_field: true

      - name: is_guest_rental
        label: "Is Guest Rental"
        description: "Flag indicating if renter checked out as a guest (without creating an account)."
        type: categorical
        expr: purchased_as_guest
        config:
          meta:
            subject: "Reservation"
            category: "Customer Type"
            bi_field: true

      - name: is_mobile_booking
        label: "Is Mobile Booking"
        description: "Flag indicating if rental was booked via mobile device."
        type: categorical
        expr: CASE WHEN rental_source_device_category = 'Mobile' THEN true ELSE false END
        config:
          meta:
            subject: "Reservation"
            category: "Channel"
            bi_field: true

    measures:
      # ===== REVENUE MEASURES =====
      - name: total_revenue
        label: "Total Revenue"
        description: "Sum of rental checkout amounts in local currency from completed rentals (event_type = 'completed'). Includes all fees and taxes."
        agg: sum
        expr: case when rental_event_type = 'completed' then rental_checkout_amount_local else 0 end
        config:
          meta:
            subject: "Rentals"
            category: "Metrics"
            hidden: true
            note: "Filtered to completed events only - primary business metric"

      - name: operator_remit
        label: "Operator Remit"
        description: "Sum of amounts in local currency remitted to operators from completed rentals (event_type = 'completed'). Revenue minus SpotHero commission."
        agg: sum
        expr: case when rental_event_type = 'completed' then operator_remit_amount_local else 0 end
        config:
          meta:
            subject: "Rentals"
            category: "Metrics"
            hidden: true
            note: "Filtered to completed events only"

      # ===== FEE BREAKDOWN MEASURES (for GMV/GOV calculations) =====
      - name: total_rental_base
        label: "Total Rental Base"
        description: "Sum of base parking amounts in cents for completed rentals. This is the core rental cost before fees."
        agg: sum
        expr: case when rental_event_type = 'completed' then coalesce(total_rental_base_amount, 0) else 0 end
        config:
          meta:
            subject: "Rentals"
            category: "Metrics"
            hidden: true
            note: "Pre-refund base amount - for GMV calculation"

      - name: total_spothero_fees
        label: "Total SpotHero Fees"
        description: "Sum of SpotHero service fees in cents for completed rentals. Includes blanket, monthly, and event fees."
        agg: sum
        expr: case when rental_event_type = 'completed' then coalesce(total_spothero_fee_amount, 0) else 0 end
        config:
          meta:
            subject: "Rentals"
            category: "Metrics"
            hidden: true
            note: "SpotHero retains these fees - GOV minus this equals GMV"

      - name: total_operator_fees
        label: "Total Operator Fees"
        description: "Sum of operator fees in cents for completed rentals. Includes reservation, oversize, and airport fees."
        agg: sum
        expr: case when rental_event_type = 'completed' then coalesce(total_operator_fee_amount, 0) else 0 end
        config:
          meta:
            subject: "Rentals"
            category: "Metrics"
            hidden: true
            note: "Remitted to operator along with base amount"

      # ===== COUNT MEASURES =====
      - name: rental_count
        label: "Rental Count"
        description: "Count of completed rental transactions (event_type = 'completed')."
        agg: sum
        expr: case when rental_event_type = 'completed' then 1 else 0 end
        config:
          meta:
            subject: "Rentals"
            category: "Metrics"
            hidden: true
            note: "Filtered to completed events only"

      - name: renter_count
        label: "Renter Count"
        description: "Distinct count of renters with completed rental transactions (event_type = 'completed')."
        agg: count_distinct
        expr: case when rental_event_type = 'completed' then renter_id else null end
        config:
          meta:
            subject: "Customers"
            category: "Metrics"
            hidden: true
            note: "Filtered to completed events only"

      # ===== DURATION/TIMING MEASURES =====
      - name: total_rental_hours
        label: "Total Rental Hours"
        description: "Sum of rental duration in hours for completed rentals (event_type = 'completed')."
        agg: sum
        expr: case when rental_event_type = 'completed' then rental_duration_minutes / 60.0 else 0 end
        config:
          meta:
            subject: "Rentals"
            category: "Metrics"
            hidden: true
            note: "Filtered to completed events only"

      - name: average_lead_time_hours
        label: "Average Lead Time (Hours)"
        description: "Average hours between booking creation and rental start time for completed rentals (event_type = 'completed')."
        agg: average
        expr: case when rental_event_type = 'completed' then lead_time_days * 24 else null end
        config:
          meta:
            subject: "Rentals"
            category: "Metrics"
            hidden: true
            note: "Filtered to completed events only"

      # ===== ANALYTICAL MEASURES (ALL STATUSES - FOR VALIDATION) =====
      - name: total_revenue_all_statuses
        label: "Total Revenue (All Statuses)"
        description: "Revenue in local currency across all event types (COMPLETE, CANCELLED, REFUNDED, etc.) - for validation and reconciliation."
        agg: sum
        expr: rental_checkout_amount_local
        config:
          meta:
            subject: "Rentals"
            category: "Metrics"
            bi_field: false
            hidden: true
            note: "Unfiltered - includes all event types for validation"

      - name: operator_remit_all_statuses
        label: "Operator Remit (All Statuses)"
        description: "Operator remittance in local currency across all event types - for validation."
        agg: sum
        expr: operator_remit_amount_local
        config:
          meta:
            subject: "Rentals"
            category: "Metrics"
            bi_field: false
            hidden: true
            note: "Unfiltered - for validation"

      - name: rental_count_all_statuses
        label: "Rental Count (All Statuses)"
        description: "Count of all rental events regardless of status - for validation and event analysis."
        agg: sum
        expr: "1"
        config:
          meta:
            subject: "Rentals"
            category: "Metrics"
            bi_field: false
            hidden: true
            note: "Unfiltered - includes all event types"

      - name: renter_count_all_statuses
        label: "Renter Count (All Statuses)"
        description: "Distinct count of renters across all event types - for validation."
        agg: count_distinct
        expr: renter_id
        config:
          meta:
            subject: "Customers"
            category: "Metrics"
            bi_field: false
            hidden: true
            note: "Unfiltered - for validation"

      - name: parking_spot_count_all_statuses
        label: "Parking Spot Count (All Statuses)"
        description: "Distinct count of facilities with any rental activity - for validation."
        agg: count_distinct
        expr: facility_id
        config:
          meta:
            subject: "Facilities"
            category: "Metrics"
            bi_field: false
            hidden: true
            note: "Unfiltered - for validation"

      - name: total_rental_hours_all_statuses
        label: "Total Rental Hours (All Statuses)"
        description: "Sum of rental duration across all event types - for validation."
        agg: sum
        expr: rental_duration_minutes / 60.0
        config:
          meta:
            subject: "Rentals"
            category: "Metrics"
            bi_field: false
            hidden: true
            note: "Unfiltered - for validation"

      # ===== FACILITY COUNT MEASURES (for LookML parity) =====
      # These measures count distinct canonical facilities with rental activity.
      # Used to replicate LookML facility lifecycle metrics where "active" = has revenue in period.
      - name: active_canonical_facility_count
        label: "Active Canonical Facility Count"
        description: |
          Distinct count of canonical facilities with completed rental revenue in the period.
          This matches the LookML definition of "active" (MTD GOV > 0).
        agg: count_distinct
        expr: case when rental_event_type = 'completed' then canonical_facility_id else null end
        config:
          meta:
            subject: "Facilities"
            category: "Metrics"
            hidden: true
            note: "LookML parity - active = has completed revenue"
