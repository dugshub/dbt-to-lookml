version: 2

semantic_models:
  - name: rental_orders
    description: |
      Semantic model for rental transactions based on the fct_rental conforming
      layer.

      This model enables self-service analytics for rental revenue, volumes, and operational
      metrics.

      Provides a single source of truth for rental-related business metrics and dimensions.
    
    model: ref('fct_rental')
    
    # ========== Configuration ==========
    config:
      meta:
        domain: commerce
        owner: Analytics Team
        contains_pii: false
        update_frequency: real-time
    
    # ========== Defaults ==========
    defaults:
      agg_time_dimension: rental_created_date
    
    # ========== Entities ==========
    entities:
      - name: rental_order
        type: primary
        expr: unique_rental_id
        description: Unique identifier for each rental transaction
      
      - name: rental
        type: foreign
        expr: rental_sk
        description: Rental surrogate key for joining with rental dimensions
      
      - name: renter
        type: foreign
        expr: customer_sk
        description: Renter surrogate key for joining with user dimensions
      
      - name: facility
        type: foreign
        expr: facility_sk
        description: Facility surrogate key for joining with facility dimensions
    
    # ========== Dimensions ==========
    dimensions:
      # Entity Identifiers
      - name: rental_id
        type: categorical
        expr: rental_id
        description: Natural rental identifier for user reference
        label: Rental ID
      
      - name: facility_id
        type: categorical
        expr: facility_id
        description: Natural facility identifier for user reference
        label: Facility ID
      
      - name: renter_id
        type: categorical
        expr: renter_id
        description: Natural renter identifier for user reference
        label: Renter ID
      
      # Time Dimensions
      - name: rental_created_date
        type: time
        type_params:
          time_granularity: day
        expr: rental_created_date
        description: Date when the rental was created
        label: Created Date
      
      - name: rental_starts_date
        type: time
        type_params:
          time_granularity: day
        expr: rental_starts_date
        description: Date when the rental period starts
        label: Start Date
      
      - name: rental_ends_date
        type: time
        type_params:
          time_granularity: day
        expr: rental_ends_date
        description: Date when the rental period ends
        label: End Date
      
      # Status Dimensions
      - name: reservation_status
        type: categorical
        expr: rental_reservation_status
        description: Current status of the rental reservation
        label: Reservation Status
      
      - name: payment_status
        type: categorical
        expr: rental_payment_status
        description: Payment status of the rental
        label: Payment Status
      
      - name: event_type
        type: categorical
        expr: rental_event_type
        description: Type of rental event
        label: Event Type
      
      # Booking Type Dimensions
      - name: has_monthly_subscription
        type: categorical
        expr: case when monthly_subscription_id is not null then 'Yes' else 'No' end
        description: Whether rental is associated with monthly subscription
        label: Has Monthly Subscription
      
      - name: has_event_booking
        type: categorical
        expr: case when event_id is not null then 'Yes' else 'No' end
        description: Whether rental is associated with an event
        label: Has Event Booking
      
      - name: has_partner_booking
        type: categorical
        expr: case when partner_id is not null then 'Yes' else 'No' end
        description: Whether rental came through a partner
        label: Has Partner Booking
      
      # Derived Category Dimensions
      - name: lead_time_category
        type: categorical
        expr: |
          case 
            when lead_time_days < 1 then 'Same Day'
            when lead_time_days between 1 and 7 then '1-7 Days'
            when lead_time_days between 8 and 30 then '1-4 Weeks'
            when lead_time_days > 30 then 'More than 30 Days'
            else 'Unknown'
          end
        description: Categorized lead time from booking to rental start
        label: Lead Time Category
      
      - name: duration_category
        type: categorical
        expr: |
          case 
            when rental_duration_minutes <= 60 then '1 Hour or Less'
            when rental_duration_minutes <= 240 then '2-4 Hours'
            when rental_duration_minutes <= 480 then '4-8 Hours'
            when rental_duration_minutes <= 1440 then '8-24 Hours'
            when rental_duration_minutes > 1440 then 'More than 1 Day'
            else 'Unknown'
          end
        description: Categorized rental duration
        label: Duration Category
    
    # ========== Measures ==========
    measures:
      # Count Measures
      - name: rental_count
        agg: count
        expr: unique_rental_id
        description: Total number of rental transactions
        label: Rental Count
        create_metric: true
      
      - name: active_rental_count
        agg: count
        expr: case when rental_reservation_status = 'active' then unique_rental_id else null end
        description: Count of active rental transactions
        label: Active Rentals
        create_metric: true
      
      - name: completed_rental_count
        agg: count
        expr: case when rental_reservation_status = 'completed' then unique_rental_id else null end
        description: Count of completed rental transactions
        label: Completed Rentals
        create_metric: true
      
      - name: canceled_rental_count
        agg: count
        expr: case when rental_reservation_status = 'canceled' then unique_rental_id else null end
        description: Count of canceled rental transactions
        label: Canceled Rentals
        create_metric: true
      
      # Sum Measures - Revenue
      - name: total_checkout_amount
        agg: sum
        expr: rental_checkout_amount_local
        description: Total checkout amount across all rentals
        label: Total Checkout Amount
        create_metric: true
      
      - name: total_spothero_net_revenue
        agg: sum
        expr: spothero_net_revenue_local
        description: Total SpotHero net revenue across all rentals
        label: Total Net Revenue
        create_metric: true
      
      - name: total_operator_remit
        agg: sum
        expr: operator_remit_amount_local
        description: Total amount remitted to parking operators
        label: Total Operator Remit
      
      - name: total_credit_used
        agg: sum
        expr: credit_used_amount_local
        description: Total credits used across all rentals
        label: Total Credits Used
      
      # Average Measures - Financial
      - name: avg_checkout_amount
        agg: average
        expr: rental_checkout_amount_local
        description: Average checkout amount per rental
        label: Avg Checkout Amount
        create_metric: true
      
      - name: avg_spothero_net_revenue
        agg: average
        expr: spothero_net_revenue_local
        description: Average SpotHero net revenue per rental
        label: Avg Net Revenue
      
      - name: avg_cost_per_hour
        agg: average
        expr: rental_cost_per_hour_local
        description: Average cost per hour of parking
        label: Avg Cost Per Hour
      
      - name: avg_spothero_revenue_per_hour
        agg: average
        expr: spothero_net_revenue_per_hour_local
        description: Average SpotHero net revenue per hour
        label: Avg Revenue Per Hour
        create_metric: true
      
      # Average Measures - Time & Duration
      - name: avg_rental_duration_hours
        agg: average
        expr: rental_duration_minutes / 60.0
        description: Average rental duration in hours
        label: Avg Duration (Hours)
        create_metric: true
      
      - name: avg_lead_time_days
        agg: average
        expr: lead_time_days
        description: Average lead time from booking to rental start in days
        label: Avg Lead Time (Days)
        create_metric: true
      
      # Min/Max Measures
      - name: min_checkout_amount
        agg: min
        expr: rental_checkout_amount_local
        description: Minimum checkout amount
        label: Min Checkout Amount
      
      - name: max_checkout_amount
        agg: max
        expr: rental_checkout_amount_local
        description: Maximum checkout amount
        label: Max Checkout Amount
