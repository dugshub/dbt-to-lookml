version: 2

semantic_models:
  - name: users
    description: |
      Semantic model for users based on the dim_renter conforming dimension.

      Provides comprehensive view of renter profiles, combining rental transaction behavior
      with digital engagement metrics for customer journey analysis.
    
    model: ref('dim_renter')
    
    # ========== Configuration ==========
    config:
      meta:
        domain: user
        owner: Analytics Team
        contains_pii: true
        update_frequency: real-time
    
    # ========== Defaults ==========
    defaults:
      agg_time_dimension: date_joined
    
    # ========== Entities ==========
    entities:
      - name: user
        type: primary
        expr: renter_sk
        description: Primary user entity
    
    # ========== Dimensions ==========
    dimensions:
      # User Identifiers
      - name: renter_sk
        type: categorical
        expr: renter_sk
        description: Surrogate key for the renter dimension
        label: Renter SK
        config:
          meta:
            hierarchy:
              entity: User
              category: Renter
              subcategory: Renter Profile
      
      - name: user_id
        type: categorical
        expr: user_id
        description: Natural key - unique identifier for the user
        label: User ID
        config:
          meta:
            hierarchy:
              entity: User
              category: Renter
              subcategory: Renter Profile
      
      # Personal Information
      - name: email
        type: categorical
        expr: email
        description: User's email address
        label: Email Address
        config:
          meta:
            hierarchy:
              entity: User
              category: Renter
              subcategory: Renter Profile
      
      - name: first_name
        type: categorical
        expr: first_name
        description: User's first name
        label: First Name
        config:
          meta:
            hierarchy:
              entity: User
              category: Renter
              subcategory: Renter Profile
      
      - name: last_name
        type: categorical
        expr: last_name
        description: User's last name
        label: Last Name
        config:
          meta:
            hierarchy:
              entity: User
              category: Renter
              subcategory: Renter Profile
      
      # Analytics Identifiers
      - name: mixpanel_id
        type: categorical
        expr: mixpanel_id
        description: Analytics tracking identifier
        label: Mixpanel ID
        config:
          meta:
            hierarchy:
              entity: User
              category: Platform
              subcategory: User Agent
      
      # Time Dimensions
      - name: date_joined
        type: time
        type_params:
          time_granularity: day
        expr: date_joined
        description: Date when user account was created
        label: Date Joined
        config:
          meta:
            hierarchy:
              entity: User
              category: Temporal
              subcategory: Booking Time
      
      - name: first_rental_date
        type: time
        type_params:
          time_granularity: day
        expr: first_rental_date
        description: Date of user's first rental
        label: First Rental Date
        config:
          meta:
            hierarchy:
              entity: User
              category: Temporal
              subcategory: Booking Time
      
      - name: last_rental_date
        type: time
        type_params:
          time_granularity: day
        expr: last_rental_date
        description: Date of user's most recent rental
        label: Last Rental Date
        config:
          meta:
            hierarchy:
              entity: User
              category: Temporal
              subcategory: Booking Time
      
      - name: last_activity_date
        type: time
        type_params:
          time_granularity: day
        expr: last_activity_date
        description: Most recent activity across all channels
        label: Last Activity Date
        config:
          meta:
            hierarchy:
              entity: User
              category: Temporal
              subcategory: Booking Time
      
      # Behavioral Dimensions
      - name: rental_frequency_category
        type: categorical
        expr: rental_frequency_category
        description: Classification of rental frequency (rare/occasional/regular/frequent)
        label: Rental Frequency
        config:
          meta:
            hierarchy:
              entity: User
              category: Renter
              subcategory: Renter Behavior
      
      - name: renter_engagement_tier
        type: categorical
        expr: renter_engagement_tier
        description: Business classification combining rental frequency and digital engagement
        label: Engagement Tier
        config:
          meta:
            hierarchy:
              entity: User
              category: Renter
              subcategory: Renter Behavior
      
      - name: channel_preference
        type: categorical
        expr: channel_preference
        description: User's preferred interaction channel based on session data
        label: Channel Preference
        config:
          meta:
            hierarchy:
              entity: User
              category: Platform
              subcategory: Device Type
      
      # Status Flags
      - name: is_active_renter
        type: categorical
        expr: is_active_renter
        description: Flag indicating if user is currently an active renter
        label: Is Active Renter
        config:
          meta:
            hierarchy:
              entity: User
              category: Renter
              subcategory: Renter Type
      
      - name: is_high_value_renter
        type: categorical
        expr: is_high_value_renter
        description: Flag for high-value renters (>20 sessions and >5 rentals)
        label: Is High Value
        config:
          meta:
            hierarchy:
              entity: User
              category: Renter
              subcategory: Renter Type
    
    # ========== Measures ==========
    measures:
      # Count Measures
      - name: user_count
        agg: count_distinct
        expr: renter_sk
        description: Total number of unique users
        label: User Count
        create_metric: true
        config:
          meta:
            hierarchy:
              entity: User
              category: Volume
              subcategory: Renter Count
      
      # Sum Measures - Activity
      - name: total_rentals
        agg: sum
        expr: total_rentals
        description: Total number of rentals across all users
        label: Total Rentals
        create_metric: true
        config:
          meta:
            hierarchy:
              entity: User
              category: Volume
              subcategory: Booking Count
      
      - name: total_completed_rentals
        agg: sum
        expr: total_completed_rentals
        description: Total number of completed rentals
        label: Completed Rentals
        config:
          meta:
            hierarchy:
              entity: User
              category: Volume
              subcategory: Booking Count
      
      - name: total_cancelled_rentals
        agg: sum
        expr: total_cancelled_rentals
        description: Total number of cancelled rentals
        label: Cancelled Rentals
        config:
          meta:
            hierarchy:
              entity: User
              category: Volume
              subcategory: Cancellation Count
      
      - name: total_sessions
        agg: sum
        expr: total_sessions
        description: Total number of digital sessions
        label: Total Sessions
        config:
          meta:
            hierarchy:
              entity: User
              category: Volume
              subcategory: Search Count
      
      - name: total_searches
        agg: sum
        expr: total_searches
        description: Total number of search events
        label: Total Searches
        config:
          meta:
            hierarchy:
              entity: User
              category: Volume
              subcategory: Search Count
      
      # Average Measures - Usage
      - name: avg_rentals_per_user
        agg: average
        expr: total_rentals
        description: Average number of rentals per user
        label: Avg Rentals/User
        config:
          meta:
            hierarchy:
              entity: User
              category: Customer
              subcategory: Frequency
      
      - name: avg_session_duration
        agg: average
        expr: avg_session_duration
        description: Average session duration in minutes
        label: Avg Session Duration
        config:
          meta:
            hierarchy:
              entity: User
              category: Operational
              subcategory: Parking Duration
      
      - name: avg_account_age_days
        agg: average
        expr: account_age_days
        description: Average account age in days
        label: Avg Account Age (Days)
        config:
          meta:
            hierarchy:
              entity: User
              category: Customer
              subcategory: Retention
      
      - name: avg_days_between_rentals
        agg: average
        expr: avg_days_between_rentals
        description: Average days between rentals
        label: Avg Days Between Rentals
        config:
          meta:
            hierarchy:
              entity: User
              category: Customer
              subcategory: Frequency
      
      # Rate Measures
      - name: rental_completion_rate
        agg: average
        expr: cast(total_completed_rentals as double) / nullif(total_rentals, 0)
        description: Average ratio of completed to total rentals
        label: Rental Completion Rate
        config:
          meta:
            hierarchy:
              entity: User
              category: Conversion
              subcategory: Repeat Rate
      
      - name: search_to_rental_conversion_rate_avg
        agg: average
        expr: search_to_rental_conversion_rate
        description: Average search to rental conversion rate
        label: Search to Rental Conversion
        config:
          meta:
            hierarchy:
              entity: User
              category: Conversion
              subcategory: Search To Book
