version: 2

semantic_models:
  - name: searches
    description: |
      Semantic model for search analytics providing search-level metrics
      and dimensions.

      Based on the dim_searches conforming layer model.

      Enables analysis of search behavior, result quality, and conversion funnels.
    
    model: ref('dim_searches')
    
    # ========== Configuration ==========
    config:
      meta:
        domain: search
        owner: Analytics Team
        contains_pii: false
        update_frequency: real-time
    
    # ========== Defaults ==========
    defaults:
      agg_time_dimension: search_date
    
    # ========== Entities ==========
    entities:
      - name: search
        type: primary
        expr: search_sk
        description: Search surrogate key
      
      - name: session
        type: foreign
        expr: session_id
        description: Session identifier for joining with sessions
      
      - name: user
        type: foreign
        expr: user_id
        description: User identifier for joining with users
    
    # ========== Dimensions ==========
    dimensions:
      # Search Identifiers
      - name: search_id
        type: categorical
        expr: search_id
        description: Natural search identifier for user reference
        label: Search ID
      
      # Time Dimensions
      - name: search_date
        type: time
        type_params:
          time_granularity: day
        expr: event_date
        description: Date when search occurred
        label: Search Date
      
      - name: search_timestamp
        type: time
        type_params:
          time_granularity: hour
        expr: event_timestamp
        description: Timestamp of search event
        label: Search Time
      
      # Search Context Dimensions
      - name: search_source
        type: categorical
        expr: search_source
        description: Source of the search (web, mobile, etc.)
        label: Search Source
      
      - name: device_type
        type: categorical
        expr: device_type
        description: Device type used for search
        label: Device Type
      
      - name: city
        type: categorical
        expr: city
        description: City where search was performed
        label: City
      
      # Search Criteria Dimensions
      - name: parking_type
        type: categorical
        expr: parking_type
        description: Type of parking searched for
        label: Parking Type
      
      - name: action_type
        type: categorical
        expr: action_type
        description: Type of search action
        label: Action Type
      
      # Search Behavior Flags
      - name: is_long_search
        type: categorical
        expr: is_long_search
        description: Flag for searches lasting over 60 seconds
        label: Is Long Search
      
      - name: is_high_engagement_search
        type: categorical
        expr: is_high_engagement_search
        description: Flag for searches with multiple actions
        label: Is High Engagement
      
      - name: has_nearby_results
        type: categorical
        expr: has_nearby_results
        description: Flag for searches with nearby results
        label: Has Nearby Results
      
      - name: is_filter_applied
        type: categorical
        expr: is_filter_applied
        description: Flag for searches with filters applied
        label: Filter Applied
    
    # ========== Measures ==========
    measures:
      # Count Measures
      - name: search_count
        agg: count
        expr: search_id
        description: Total number of searches
        label: Search Count
        create_metric: true
      
      - name: unique_searches
        agg: count_distinct
        expr: search_id
        description: Count of unique searches
        label: Unique Searches
        create_metric: true
      
      # User & Session Measures
      - name: unique_searching_users
        agg: count_distinct
        expr: user_id
        description: Count of unique users who searched
        label: Searching Users
        create_metric: true
      
      - name: unique_searching_sessions
        agg: count_distinct
        expr: session_id
        description: Count of unique sessions with searches
        label: Searching Sessions
      
      # Duration & Activity Measures
      - name: avg_search_duration_seconds
        agg: average
        expr: search_duration_seconds
        description: Average search duration in seconds
        label: Avg Search Duration (Sec)
        create_metric: true
      
      - name: total_search_actions
        agg: sum
        expr: total_search_actions
        description: Total number of search actions
        label: Total Search Actions
      
      # Results Quality Measures
      - name: avg_results_returned
        agg: average
        expr: total_results_returned
        description: Average number of results returned per search
        label: Avg Results Returned
      
      - name: avg_nearby_results
        agg: average
        expr: results_under_500m
        description: Average results within 500m
        label: Avg Nearby Results
      
      # Engagement Measures
      - name: high_engagement_searches
        agg: sum
        expr: case when is_high_engagement_search = true then 1 else 0 end
        description: Count of high engagement searches
        label: High Engagement Searches
        create_metric: true
      
      - name: searches_with_filters
        agg: sum
        expr: case when is_filter_applied = true then 1 else 0 end
        description: Count of searches with filters applied
        label: Filtered Searches
