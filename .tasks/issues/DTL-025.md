---
id: DTL-025
title: "Add cross-entity measure generation to LookMLGenerator"
type: feature
status: ready
labels:
  - stack:backend
  - type:feature
  - priority:high
  - state:has-spec
parent: DTL-022
created: 2025-11-18T00:00:00Z
updated: 2025-11-18T00:00:00Z
---

# DTL-025: Add cross-entity measure generation to LookMLGenerator

## Description

Extend LookMLGenerator to generate measures that reference fields from other views using `${view.measure}` syntax and `required_fields` parameter.

## What needs to be built

### New Methods in LookMLGenerator

**Metric to Measure Conversion**:
```python
def _generate_metric_measure(
    self,
    metric: Metric,
    primary_model: SemanticModel,
    all_models: list[SemanticModel]
) -> dict[str, Any]:
    """
    Generate LookML measure dict from metric definition.

    Returns dict with:
    - name
    - type (always "number" for cross-entity)
    - sql (with ${view.measure} references)
    - required_fields (list of cross-view dependencies)
    - value_format_name
    - description
    - label
    - view_label
    - group_label
    """
```

**SQL Generation by Metric Type**:
```python
def _generate_ratio_sql(
    self,
    metric: RatioMetric,
    models: dict[str, SemanticModel]
) -> str:
    """Generate SQL for ratio metric: numerator / denominator"""
    # Returns: "1.0 * ${view.num} / NULLIF(${view.denom}, 0)"

def _generate_simple_sql(
    self,
    metric: SimpleMetric,
    models: dict[str, SemanticModel]
) -> str:
    """Generate SQL for simple metric: direct measure reference"""
    # Returns: "${view.measure}" or "${measure}" if same view

def _generate_derived_sql(
    self,
    metric: DerivedMetric,
    models: dict[str, SemanticModel]
) -> str:
    """Generate SQL for derived metric with expression evaluation"""
    # Parse expr, replace metric references with ${view.measure}
```

**Required Fields Extraction**:
```python
def _extract_required_fields(
    self,
    metric: Metric,
    primary_model: SemanticModel,
    all_models: list[SemanticModel]
) -> list[str]:
    """
    Identify which fields from other views this metric requires.

    Returns list like: ["rental_orders.rental_count", "users.user_count"]

    Excludes measures from the primary model (same view).
    """
```

### Integration with View Generation

Update view generation pipeline:
1. Accept optional `metrics` parameter in `generate()` method
2. Filter metrics by `primary_entity` matching semantic model
3. Generate measure dicts for owned metrics
4. Append to existing measures in view dict

### Measure Metadata

All generated metric measures should include:
- `label`: From metric.label or titlecase(metric.name)
- `description`: From metric.description
- `view_label: " Metrics"` (leading space for sort order)
- `group_label`: "Cross-Entity Performance" or from metric.meta
- `required_fields`: List of cross-view dependencies
- `value_format_name`: Infer from metric type
  - Ratio metrics → `percent_2`
  - Revenue metrics → `usd`
  - Count metrics → `decimal_0`

### View Prefix Handling

Cross-view references must use view prefix:
```python
# If view_prefix = "v_"
# Reference: ${v_rental_orders.rental_count}
```

## Why it's needed (connection to epic)

Core logic for converting dbt metrics to LookML measures with cross-view references. This is the heart of the cross-entity metrics feature.

## Technical scope from labels

Backend work in `src/dbt_to_lookml/generators/lookml.py`:
- Add metric processing to LookMLGenerator
- Generate measures with `${view.field}` syntax
- Handle all metric types (simple, ratio, derived)
- Add `required_fields` parameter to measures
- Apply view prefix to cross-view references
- Integrate with existing view generation

## Acceptance Criteria

- [ ] `_generate_metric_measure()` creates complete measure dict
- [ ] `_generate_ratio_sql()` handles ratio metrics correctly
- [ ] `_generate_simple_sql()` handles simple metrics correctly
- [ ] `_generate_derived_sql()` handles derived metrics correctly
- [ ] `_extract_required_fields()` identifies cross-view dependencies
- [ ] Required fields excludes measures from same view
- [ ] View prefix applied correctly to cross-view references
- [ ] Measure metadata includes all required fields
- [ ] Value format inferred from metric type
- [ ] Integration with view generation (metrics added to views)

## Testing requirements

**Unit tests** (in `src/tests/unit/test_lookml_generator.py`):
- Test `_generate_metric_measure()` for each metric type
- Test SQL generation (simple, ratio, derived)
- Test `required_fields` extraction
- Test view prefix handling in cross-view references
- Test measure metadata (labels, descriptions, formats)
- Test integration with view generation
- Test metric ownership filtering (only owned metrics in view)

**Test cases**:
- Ratio metric with both measures from other views
- Ratio metric with numerator from same view
- Simple metric from same view (no required_fields)
- Simple metric from other view (has required_fields)
- Derived metric with multiple measure references
- Metric with view_prefix applied

**Coverage target**: 95%+ branch coverage for new methods

## Dependencies

- DTL-023 (needs Metric schema models)
- DTL-024 (needs parsed metrics)

## Blocked by

- DTL-023
- DTL-024

## Blocks

- DTL-026 (explore enhancement needs to know required measures)
- DTL-028 (tests need implementation)

## Links
- Epic: [DTL-022](./../epics/DTL-022.md)
- Depends on: [DTL-023](./../issues/DTL-023.md), [DTL-024](./../issues/DTL-024.md)
- Implementation plan: .tasks/plans/cross-entity-metrics-plan.yaml
- Strategy: [DTL-025-strategy.md](./../strategies/DTL-025-strategy.md)

## Notes

### SQL Generation Examples

**Ratio metric**:
```python
# Input
metric = RatioMetric(
    name="search_conversion_rate",
    numerator="rental_count",      # from rental_orders
    denominator="search_count"      # from searches (primary)
)

# Output SQL
"1.0 * ${rental_orders.rental_count} / NULLIF(${search_count}, 0)"
```

**Simple metric (cross-view)**:
```python
# Input
metric = SimpleMetric(
    name="total_revenue",
    measure="revenue"  # from rental_orders, but metric in users view
)

# Output SQL
"${rental_orders.revenue}"
```

**Simple metric (same view)**:
```python
# Input
metric = SimpleMetric(
    name="search_count_metric",
    measure="search_count"  # from searches, metric also in searches
)

# Output SQL
"${search_count}"  # No view prefix needed
```

### Value Format Inference

```python
def _infer_value_format(metric: Metric) -> str | None:
    if metric.type == "ratio":
        return "percent_2"
    if "revenue" in metric.name or "price" in metric.name:
        return "usd"
    if "count" in metric.name:
        return "decimal_0"
    return None
```

## History
### 2025-11-18 - Implementation Spec Generated
Comprehensive implementation spec created at `.tasks/specs/DTL-025-spec.md`. Key details:
- 10-phase implementation plan (2-3 week estimate)
- 54+ unit tests with 95% coverage target
- Detailed task breakdown with code examples and references
- Helper methods, SQL generation, required fields extraction, integration
- Backward compatible design with optional metrics parameter
Status updated to `ready`. Label updated to `state:has-spec`. Ready for implementation via `/implement`.

### 2025-11-18 00:00 - Issue Created
Created from epic DTL-022
