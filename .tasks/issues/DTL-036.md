---
id: DTL-036
title: "Optimize Measure Generation: Eliminate Redundant Hidden Measures for Simple Metrics"
status: done
type: feature
labels:
  - type:feature
  - stack:backend
  - priority:high
  - layer:generators
parent: null
created: 2024-12-14
---

# DTL-036: Optimize Measure Generation - Eliminate Redundant Hidden Measures

## Problem Statement

Currently, ALL dbt measures are generated as hidden LookML measures with a `_measure` suffix, and ALL metrics (including simple metrics) become `type: number` measures that reference those hidden measures.

This creates **redundant output** for simple metrics:

```yaml
# dbt input
measures:
  - name: total_revenue
    agg: sum
    expr: rental_checkout_amount_local
metrics:
  - name: rental_revenue
    type: simple
    type_params:
      measure: total_revenue
```

```lookml
# Current output (2 measures - redundant!)
measure: total_revenue_measure {
  type: sum
  sql: ${TABLE}.rental_checkout_amount_local ;;
  hidden: yes
}
measure: rental_revenue {
  type: number
  sql: ${total_revenue_measure} ;;
}
```

```lookml
# Optimal output (1 measure)
measure: rental_revenue {
  type: sum
  sql: ${TABLE}.rental_checkout_amount_local ;;
}
```

## Why Hidden Measures Exist

LookML has a constraint: **measures with aggregate types (`sum`, `count`, etc.) cannot reference other measures**. Only `type: number` can reference other measures.

This means for **ratio** and **derived** metrics, we MUST have hidden base measures:

```lookml
# Ratio metric - REQUIRES hidden measures
measure: total_revenue_measure {
  type: sum
  hidden: yes
}
measure: order_count_measure {
  type: count
  hidden: yes
}
measure: average_order_value {
  type: number  # Must be number to reference measures
  sql: ${total_revenue_measure} / NULLIF(${order_count_measure}, 0) ;;
}
```

## Proposed Solution

**Smart measure generation based on usage analysis:**

1. **Analyze phase**: Scan all metrics to determine which measures are referenced by complex (non-simple) metrics
2. **Generate phase**:
   - Simple metrics → Generate as direct aggregate measures (type: sum, count, etc.)
   - Complex metrics → Reference existing measures (either visible simple metrics or hidden measures)
   - Hidden measures → Only create for measures that are:
     - Referenced by complex metrics, AND
     - NOT already exposed via a simple metric

## Acceptance Criteria

- [ ] Simple metrics generate as direct aggregate measures (not `type: number` wrappers)
- [ ] Ratio/derived metrics correctly reference aggregate measures
- [ ] Hidden measures only created when necessary (not exposed via simple metric)
- [ ] Cross-entity metric references work correctly
- [ ] All existing tests pass
- [ ] New tests cover the optimization logic
- [ ] Test against real semantic models in `src/tests/fixtures/real_semantic_models/`

## Test Cases

Using `rentals.yml` and `real_metrics.yml` fixtures:

| Measure | Simple Metric | Complex Metric Uses It | Expected Output |
|---------|--------------|------------------------|-----------------|
| `total_revenue` | `rental_revenue` | No | `rental_revenue` as `type: sum` |
| `rentals` | `rental_count` | No | `rental_count` as `type: count_distinct` |
| `total_revenue` | `rental_revenue` | Yes (in ratio) | `rental_revenue` as `type: sum`, ratio refs `${rental_revenue}` |
| `order_count` | None | Yes (in ratio) | `order_count_measure` hidden |

## History

- 2024-12-14: Created from architecture discussion about redundant measure generation
