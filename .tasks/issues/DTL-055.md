---
id: DTL-055
title: "Add same-model detection utility for derived metrics"
type: feature
status: done
labels:
  - stack:backend
  - type:feature
  - layer:atoms
created: 2025-12-22T23:00:00Z
updated: 2025-12-22T23:00:00Z
parent: DTL-054
---

# DTL-055: Add same-model detection utility for derived metrics

## Problem Statement

To enable PoP support for derived metrics, we need a utility function that can detect
whether a derived metric qualifies for PoP generation. A derived metric qualifies when
all of its parent metrics recursively resolve to simple metrics on the same semantic model.

## What to Build

Add a function (likely in `generators/lookml.py` or a new utility module) that:
1. Takes a metric and list of all metrics
2. Recursively traverses `type_params.metrics` for derived metrics
3. Checks that ALL leaf metrics are `type: simple`
4. Verifies all parent metrics share the same `primary_entity`
5. Returns a tuple: `(qualifies: bool, parent_metric_names: list[str])`

## Technical Details

- Handle nested derived metrics: derived -> derived -> simple
- Detect and handle circular references gracefully (return False)
- Consider caching for metrics checked multiple times
- Should work with the existing Metric and SemanticModel schemas

## Function Signature

```python
def is_same_model_derived_metric(
    metric: Metric,
    all_metrics: list[Metric],
    all_models: list[SemanticModel],
) -> tuple[bool, list[str]]:
    """Detect if a derived metric qualifies for PoP generation.

    A derived metric qualifies when all parent metrics:
    - Recursively resolve to simple metrics
    - Share the same primary_entity (same semantic model)

    Args:
        metric: The derived metric to check.
        all_metrics: All metrics for recursive lookup.
        all_models: All models for entity resolution.

    Returns:
        Tuple of (qualifies, list of parent metric names).
        Returns (False, []) for non-qualifying metrics.
    """
```

## Testing Requirements

- Unit tests for simple qualifying cases
- Unit tests for nested derived metrics
- Unit tests for cross-model cases (should return False)
- Unit tests for edge cases (missing parent, circular ref)

## Success Criteria

- [ ] Implementation complete
- [ ] Tests passing
- [ ] Documentation updated

## Links

- Epic: [DTL-054](./../epics/DTL-054.md)
- Strategy: [.tasks/strategies/DTL-055-strategy.md](./../strategies/DTL-055-strategy.md)
- Spec: [.tasks/specs/DTL-055-spec.md](./../specs/DTL-055-spec.md)

## History

### 2025-12-22 23:00 - Issue Created
Created from epic DTL-054
