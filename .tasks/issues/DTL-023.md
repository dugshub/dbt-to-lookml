---
id: DTL-023
title: "Add Metric schema models to schemas.py"
type: feature
status: ready
labels:
  - stack:backend
  - type:feature
  - priority:high
  - state:has-spec
parent: DTL-022
created: 2025-11-18T00:00:00Z
updated: 2025-11-18T00:00:00Z
---

# DTL-023: Add Metric schema models to schemas.py

## Description

Extend Pydantic schema models to support dbt metrics with all metric types and metadata.

## What needs to be built

### New Models

**Base Metric Model**:
```python
class Metric(BaseModel):
    name: str
    type: Literal["simple", "ratio", "derived", "conversion"]
    type_params: MetricTypeParams
    label: str | None = None
    description: str | None = None
    meta: dict[str, Any] | None = None

    @property
    def primary_entity(self) -> str | None:
        """Extract primary_entity from meta block."""
        if self.meta:
            return self.meta.get("primary_entity")
        return None
```

**Type-Specific Params**:
```python
class SimpleMetricParams(BaseModel):
    measure: str

class RatioMetricParams(BaseModel):
    numerator: str
    denominator: str

class DerivedMetricParams(BaseModel):
    expr: str
    metrics: list[MetricReference]

class ConversionMetricParams(BaseModel):
    conversion_type_params: dict[str, Any]

MetricTypeParams = Union[
    SimpleMetricParams,
    RatioMetricParams,
    DerivedMetricParams,
    ConversionMetricParams
]
```

**Helper Models**:
```python
class MetricReference(BaseModel):
    name: str
    alias: str | None = None
    offset_window: str | None = None
```

### Validation

- All metric names must be globally unique
- Type params must match metric type
- Primary entity (if specified) must reference valid entity name
- Measure references must exist in semantic models

## Why it's needed (connection to epic)

Foundation for parsing dbt metric files and generating cross-entity LookML measures. Without these schema models, we cannot represent dbt metrics in the codebase.

## Technical scope from labels

Backend work in `src/dbt_to_lookml/schemas.py`:
- Add new Pydantic models with full type hints (mypy --strict compliance)
- Follow existing schema patterns (BaseModel, Optional fields)
- Add helper methods for extracting dependencies
- Maintain backward compatibility with existing schemas

## Acceptance Criteria

- [ ] `Metric` base model with all required fields
- [ ] Type-specific params for simple, ratio, derived, conversion
- [ ] `primary_entity` property extracts from meta block
- [ ] Validation ensures type_params match metric type
- [ ] All models pass mypy --strict type checking
- [ ] Unit tests for model validation (each metric type)
- [ ] Unit tests for primary_entity extraction
- [ ] Unit tests for validation edge cases

## Testing requirements

**Unit tests** (in `src/tests/unit/test_schemas.py`):
- Test Metric model validation for each type
- Test SimpleMetricParams, RatioMetricParams, DerivedMetricParams
- Test primary_entity property (present, missing, nested in meta)
- Test validation edge cases (invalid type, mismatched params)
- Test MetricReference model

**Coverage target**: 100% for new models

## Dependencies

- None (foundation layer)

## Blocked by

- None

## Blocks

- DTL-024 (parser needs these models)
- DTL-025 (generator needs these models)

## Links
- Epic: [DTL-022](./../epics/DTL-022.md)
- Implementation plan: .tasks/plans/cross-entity-metrics-plan.yaml
- Strategy: [DTL-023-strategy.md](./../strategies/DTL-023-strategy.md)

## Notes

- Use `Literal` for type field to ensure valid metric types
- Use Union for MetricTypeParams to support all variants
- Follow existing pattern from SemanticModel, Measure, Dimension
- Consider adding `model_config = {"extra": "forbid"}` to catch typos

## History
### 2025-11-18 - Implementation Spec Generated
Detailed implementation spec created from approved strategy:
- 10 implementation tasks with file-level guidance
- Code patterns and references from existing codebase
- 30-35 unit tests with specific test cases
- Validation commands and acceptance checklist
- File changes: types.py (~8 lines), schemas.py (~245 lines), test_schemas.py (~400-500 lines)
- Estimated effort: 3.5 hours (1.5 implementation + 2 testing)
See: .tasks/specs/DTL-023-spec.md

### 2025-11-18 - Implementation Strategy Approved
Comprehensive implementation strategy created covering:
- Discriminated union architecture for type-specific params
- Six-phase implementation plan (1.5 hour estimate)
- 30-35 unit tests with 100% coverage target
- Clear architectural decisions and risk assessment
See: .tasks/strategies/DTL-023-strategy.md

### 2025-11-18 00:00 - Issue Created
Created from epic DTL-022
