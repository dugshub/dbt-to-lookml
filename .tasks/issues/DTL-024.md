---
id: DTL-024
title: "Implement dbt metrics YAML parser"
type: feature
status: ready
labels:
  - stack:backend
  - type:feature
  - priority:high
  - state:has-spec
parent: DTL-022
created: 2025-11-18T00:00:00Z
updated: 2025-11-18T00:00:00Z
---

# DTL-024: Implement dbt metrics YAML parser

## Description

Create parser to read dbt metric YAML files and convert to Metric schema models.

## What needs to be built

### New Module: `parsers/dbt_metrics.py`

**Main Parser Class**:
```python
class DbtMetricParser(Parser):
    def parse_file(self, file_path: Path) -> list[Metric]:
        """Parse a single metric YAML file."""

    def parse_directory(self, directory: Path) -> list[Metric]:
        """Parse all metric files in directory."""

    def _validate_metric(
        self,
        metric: Metric,
        semantic_models: list[SemanticModel]
    ) -> None:
        """Validate metric references valid measures and entities."""
```

**Primary Entity Resolution**:
```python
def resolve_primary_entity(
    metric: Metric,
    semantic_models: list[SemanticModel]
) -> str:
    """
    Determine primary entity for metric.

    Priority:
    1. Explicit meta.primary_entity
    2. Infer from denominator (ratio metrics only)
    3. Raise error - require explicit specification
    """
```

**Dependency Extraction**:
```python
def extract_measure_dependencies(metric: Metric) -> set[str]:
    """Extract all measure names referenced by metric."""
```

### File Discovery

- Scan `metrics/` directory (configurable via CLI)
- Support `*.yml` and `*.yaml` extensions
- Handle nested directories
- Skip invalid/malformed files with warnings

### Error Handling

- Invalid YAML syntax → Clear error with line number
- Missing required fields → Validation error with field name
- Unknown metric type → Error with list of supported types
- Unreferenced measures → Warning (not error)
- Missing primary_entity (when can't infer) → Error with guidance

## Why it's needed (connection to epic)

Enables reading dbt metric definitions so they can be converted to LookML. Without this, we can't access metric data from dbt projects.

## Technical scope from labels

Backend work in `src/dbt_to_lookml/parsers/`:
- Create new `dbt_metrics.py` module
- Extend base `Parser` interface if needed
- Integrate with existing file reading utilities (reuse YAML reading)
- Use Pydantic validation for data integrity
- Follow error handling patterns from `dbt.py` parser

## Acceptance Criteria

- [ ] `DbtMetricParser` class extends `Parser` base class
- [ ] `parse_file()` successfully parses single metric YAML
- [ ] `parse_directory()` recursively scans and parses all metric files
- [ ] `resolve_primary_entity()` handles explicit and inferred cases
- [ ] `extract_measure_dependencies()` finds all measure references
- [ ] Error handling provides clear, actionable messages
- [ ] Validation integrates with semantic models
- [ ] Parser handles all metric types (simple, ratio, derived, conversion)

## Testing requirements

**Unit tests** (in `src/tests/unit/test_dbt_metric_parser.py`):
- Test parse_file for each metric type
- Test parse_directory with multiple files
- Test parse_directory with nested directories
- Test primary entity resolution (explicit, inferred from denominator, error)
- Test dependency extraction for each metric type
- Test error handling (invalid YAML, missing fields, unknown type)
- Test validation with semantic models
- Test warning for unreferenced measures

**Integration tests** (in `src/tests/integration/`):
- Create real metric YAML fixtures
- Test end-to-end parsing with semantic models
- Verify parsed metrics match expected structure

**Coverage target**: 95%+ branch coverage

## Dependencies

- DTL-023 (needs Metric schema models)

## Blocked by

- DTL-023

## Blocks

- DTL-025 (generator needs parsed metrics)
- DTL-027 (validation needs parsed metrics)

## Links
- Epic: [DTL-022](./../epics/DTL-022.md)
- Depends on: [DTL-023](./../issues/DTL-023.md)
- Implementation plan: .tasks/plans/cross-entity-metrics-plan.yaml

## Notes

### Inference Logic for Primary Entity

For ratio metrics without explicit `meta.primary_entity`:
1. Extract denominator measure name
2. Find semantic model containing that measure
3. Get that model's primary entity
4. Use as metric's primary entity

**Rationale**: The denominator represents the "universe" being measured, which should be the explore spine.

### Example Metric Files

**Simple metric**:
```yaml
metrics:
  - name: total_revenue
    type: simple
    type_params:
      measure: revenue
    meta:
      primary_entity: rental
```

**Ratio metric with inference**:
```yaml
metrics:
  - name: search_conversion_rate
    type: ratio
    type_params:
      numerator: rental_count
      denominator: search_count
    # No meta.primary_entity → infer from search_count → search entity
```

**Ratio metric with explicit primary**:
```yaml
metrics:
  - name: revenue_per_user
    type: ratio
    type_params:
      numerator: total_revenue
      denominator: user_count
    meta:
      primary_entity: user  # Explicit
```

## History
### 2025-11-18 00:00 - Issue Created
Created from epic DTL-022

### 2025-11-18 - Strategy Completed
Implementation strategy created at `.tasks/strategies/DTL-024-strategy.md`. Key architectural decisions:
- Extend base Parser interface for consistency with DbtParser
- Support all 4 metric types (simple, ratio, derived, conversion)
- Smart primary entity inference from denominator for ratio metrics
- Comprehensive error handling with clear, actionable messages
- 95%+ test coverage target with fixtures for all metric types

Status updated to `state:has-strategy`.

### 2025-11-18 - Implementation Spec Generated
Detailed implementation spec created at `.tasks/specs/DTL-024-spec.md`. Spec includes:
- 6-phase implementation plan with detailed task breakdown
- File-level implementation guidance with code patterns and references
- Complete test strategy with 35-40 test cases defined
- Test fixture structures for all 4 metric types
- Validation commands and quality gate instructions
- Comprehensive notes on code patterns from existing DbtParser

Issue status updated to `ready` with label `state:has-spec`. Ready for implementation after DTL-023 completion.
