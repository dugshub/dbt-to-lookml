---
id: DTL-057
title: "Add comprehensive test coverage for derived metric PoP"
type: feature
status: spec-ready
labels:
  - stack:backend
  - type:feature
  - layer:features
  - tdd:true
created: 2025-12-22T23:00:00Z
updated: 2025-12-22T23:00:00Z
parent: DTL-054
---

# DTL-057: Add comprehensive test coverage for derived metric PoP

## Problem Statement

The derived metric PoP feature requires thorough test coverage to ensure correctness
across various scenarios including same-model detection, PoP generation, and edge cases.

## What to Build

Add tests in `tests/unit/` covering:

### Same-Model Detection Tests

- `test_same_model_detection_simple_parents`: All parents simple on same model -> True
- `test_same_model_detection_nested_derived`: derived -> derived -> simple -> True
- `test_same_model_detection_cross_model`: Parents on different models -> False
- `test_same_model_detection_mixed_types`: Some parents not simple -> False
- `test_same_model_detection_circular_ref`: Circular reference -> False
- `test_same_model_detection_missing_parent`: Parent metric not found -> False

### PoP Generation Tests

- `test_derived_metric_pop_generation`: Verify PoP measures created for qualifying metric
- `test_derived_metric_pop_labels`: Verify labels match simple metric pattern
- `test_derived_metric_pop_config_inheritance`: PoP config (windows, comparisons) inherited
- `test_derived_metric_pop_skipped_cross_model`: Cross-model derived skipped silently
- `test_derived_metric_pop_with_date_selector`: Works with date_selector enabled

### Integration Tests

- End-to-end test with real semantic model fixture containing derived metric with PoP
- Verify generated LookML is syntactically valid

## Test Files

- Create `test_derived_metric_pop.py` for isolated unit tests
- Add integration tests to existing test files or create `test_derived_metric_pop_integration.py`

## Fixtures

- Semantic model with simple metrics and derived metric referencing them
- Nested derived metric (derived -> derived -> simple)
- Cross-model derived metric (parents on different models)
- Derived metric with PoP config enabled

## Success Criteria

- [ ] Implementation complete
- [ ] Tests passing
- [ ] Documentation updated

## Links

- Epic: [DTL-054](./../epics/DTL-054.md)
- Strategy: [.tasks/strategies/DTL-057-strategy.md](./../strategies/DTL-057-strategy.md)
- Spec: [.tasks/specs/DTL-057-spec.md](./../specs/DTL-057-spec.md)

## History

### 2025-12-22 23:00 - Issue Created
Created from epic DTL-054
