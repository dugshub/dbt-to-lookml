---
id: DTL-056
title: "Update PoP generation to include qualifying derived metrics"
type: feature
status: spec-ready
labels:
  - stack:backend
  - type:feature
  - layer:features
created: 2025-12-22T23:00:00Z
updated: 2025-12-22T23:00:00Z
parent: DTL-054
---

# DTL-056: Update PoP generation to include qualifying derived metrics

## Problem Statement

Currently, the PoP generation flow in `generators/lookml.py` processes all metrics with
`pop.enabled`, but the resulting `period_over_period` measures only work correctly for
simple metrics. Derived metrics are processed but may not generate valid PoP measures.

## What to Build

Update `_generate_metric_pop_measures` and related code in `generators/lookml.py`:
1. Before generating PoP for a metric, check if it's a derived metric
2. If derived, run the same-model detection utility (DTL-055)
3. If qualifying, proceed with `period_over_period` generation using `based_on: metric_name`
4. If not qualifying, skip silently (preserve current behavior for cross-model)

## Technical Details

- The derived metric's LookML measure is `type: number` with SQL like `${parent_a} - ${parent_b}`
- Looker's `period_over_period` supports `type: number` as `based_on` when it references aggregates
- Use the same PoP generation pattern as simple metrics: previous, difference, relative_change
- Inherit PoP config from the derived metric's `meta.pop` settings

## Integration Points

- Depends on same-model detection utility from DTL-055
- Uses existing `_generate_metric_pop_measures` infrastructure
- Works with both measure-level and metric-level PoP flows

## Code Location

The main changes will be in:
- `src/dbt_to_lookml/generators/lookml.py` around lines 2230-2290 (metric PoP generation)
- Possibly add a filtering step before calling `_generate_metric_pop_measures`

## Testing Requirements

- Integration test: derived metric generates PoP variants
- Integration test: nested derived metric generates PoP variants
- Integration test: cross-model derived metric is skipped
- Verify generated LookML is valid and parseable

## Success Criteria

- [ ] Implementation complete
- [ ] Tests passing
- [ ] Documentation updated

## Links

- Epic: [DTL-054](./../epics/DTL-054.md)
- Strategy: [.tasks/strategies/DTL-056-strategy.md](./../strategies/DTL-056-strategy.md)
- Spec: [.tasks/specs/DTL-056-spec.md](./../specs/DTL-056-spec.md)

## History

### 2025-12-22 23:00 - Issue Created
Created from epic DTL-054
