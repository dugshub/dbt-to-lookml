---
id: DTL-043
title: "Generate visible PoP measure group"
type: feature
status: refinement
labels:
  - stack:backend
  - type:feature
  - priority:high
created: 2025-12-15T19:30:00Z
updated: 2025-12-15T19:30:00Z
parent: DTL-037
---

# DTL-043: Generate visible PoP measure group

## Problem Statement

Generate the user-facing measure group with current, comparison, delta, and % change.

## What to Build

Four visible measures per pop-enabled metric:

1. **Current Value** - Switches based on period_grain parameter
2. **Comparison Value** - Switches based on grain + comparison parameters
3. **Delta (Change)** - Current minus comparison
4. **Percent Change** - Delta / comparison (with NULLIF protection)

## Example Output

```lookml
measure: revenue {
  group_label: "Revenue"
  label: "Revenue"
  type: number
  value_format_name: usd
  sql: CASE {% parameter period_grain %}
         WHEN 'selected' THEN ${revenue_measure}
         WHEN 'mtd' THEN ${revenue_mtd_measure}
         WHEN 'ytd' THEN ${revenue_ytd_measure}
       END ;;
}

measure: revenue_comparison {
  group_label: "Revenue"
  label: "Revenue (Comp)"
  type: number
  value_format_name: usd
  required_fields: [revenue]
  sql: CASE
         WHEN {% parameter period_grain %} = 'selected' AND {% parameter comparison_period %} = 'pp'
           THEN ${revenue_pp_measure}
         WHEN {% parameter period_grain %} = 'selected' AND {% parameter comparison_period %} = 'py'
           THEN ${revenue_py_measure}
         WHEN {% parameter period_grain %} = 'mtd' AND {% parameter comparison_period %} = 'pp'
           THEN ${revenue_mtd_pp_measure}
         WHEN {% parameter period_grain %} = 'mtd' AND {% parameter comparison_period %} = 'py'
           THEN ${revenue_mtd_py_measure}
         WHEN {% parameter period_grain %} = 'ytd' AND {% parameter comparison_period %} = 'pp'
           THEN ${revenue_ytd_pp_measure}
         WHEN {% parameter period_grain %} = 'ytd' AND {% parameter comparison_period %} = 'py'
           THEN ${revenue_ytd_py_measure}
       END ;;
}

measure: revenue_change {
  group_label: "Revenue"
  label: "Revenue Δ"
  type: number
  value_format_name: usd
  required_fields: [revenue, revenue_comparison]
  sql: ${revenue} - ${revenue_comparison} ;;
}

measure: revenue_pct_change {
  group_label: "Revenue"
  label: "Revenue %Δ"
  type: number
  value_format_name: percent_1
  required_fields: [revenue, revenue_comparison]
  sql: (${revenue} - ${revenue_comparison}) / NULLIF(${revenue_comparison}, 0) ;;
}
```

## Why It's Needed

These are the measures users interact with in Looker. The CASE statement pattern
allows a single measure to represent multiple calculations based on parameter values.

## Technical Scope

- File: `src/dbt_to_lookml/generators/lookml.py`
- New method: `_generate_pop_visible_measures()`
- Apply format from pop config (usd, decimal, percent)
- Use group_label for measure organization
- Add required_fields for dependent measures

## Success Criteria

- [ ] CASE statement generation for all grain/comparison combos
- [ ] value_format_name application from pop config
- [ ] group_label assignment for grouping
- [ ] required_fields linkage for dependent measures
- [ ] Percent change NULLIF protection

## Links

- Epic: [DTL-037](./../epics/DTL-037.md)
- Strategy: [.tasks/strategies/DTL-043-strategy.md](./../strategies/DTL-043-strategy.md)
- Spec: [.tasks/specs/DTL-043-spec.md](./../specs/DTL-043-spec.md)

## History

### 2025-12-15 19:30 - Issue Created
Created from epic DTL-037
