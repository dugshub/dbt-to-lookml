---
id: DTL-038
title: "Add PoP configuration schema"
type: feature
status: refinement
labels:
  - stack:backend
  - type:feature
  - priority:high
created: 2025-12-15T19:30:00Z
updated: 2025-12-15T19:30:00Z
parent: DTL-037
---

# DTL-038: Add PoP configuration schema

## Problem Statement

Create Pydantic models for PoP (Period-over-Period) configuration in `schemas/config.py`.

## What to Build

- `PopConfig` model with fields: enabled, grains, comparisons, windows, format, date_dimension, date_filter
- `PopGrain` enum: selected, mtd, ytd, qtd, wtd (Phase 1: selected, mtd, ytd only)
- `PopComparison` enum: pp (prior period), py (prior year)
- `PopWindow` enum: week, month, quarter (defines what "Prior Period" means)
- Add `pop: PopConfig | None` field to `ConfigMeta` class
- Support model-level `pop.date_dimension` default in semantic model config

### PopConfig Fields

| Field | Type | Required | Description |
|-------|------|----------|-------------|
| `enabled` | bool | Yes | Enable PoP generation for this measure |
| `grains` | list[PopGrain] | No | Which grains to generate (default: [mtd, ytd]) |
| `comparisons` | list[PopComparison] | No | Which comparisons to generate (default: [pp, py]) |
| `windows` | list[PopWindow] | No | What "Prior Period" can mean (default: [month]) |
| `format` | str | No | LookML value_format_name (e.g., "usd", "decimal_2") |
| `date_dimension` | str | No | Dimension for PoP SQL (e.g., "selected_date") |
| `date_filter` | str | No | Filter field for {% date_start/end %} (defaults to {date_dimension}_date) |

### The Three PoP Dimensions

| Parameter | Config Field | Purpose |
|-----------|--------------|---------|
| `period_window` | `windows` | What's a "period"? (week/month/quarter) |
| `period_grain` | `grains` | Use date filter as-is or override to to-date? (selected/mtd/ytd) |
| `comparison_period` | `comparisons` | Compare to what? (pp/py) |

### PopGrain Values

| Value | Label | Meaning |
|-------|-------|---------|
| `selected` | "Selected Range" | Use the date filter as-is, no override |
| `mtd` | "Month to Date" | Override to current month through today |
| `ytd` | "Year to Date" | Override to current year through today |
| `qtd` | "Quarter to Date" | (Phase 2) Override to current quarter through today |
| `wtd` | "Week to Date" | (Phase 2) Override to current week through today |

### Field Resolution

1. `date_filter`: pop config → derive as `{date_dimension}_date`
2. `date_dimension`: pop config → model config → `defaults.agg_time_dimension`
3. `windows`: pop config → model config → default `[month]`

## Why It's Needed

The PoP feature needs strongly-typed configuration parsing to validate user input
and provide clear error messages. This schema is the foundation for parser and
generator components.

## Technical Scope

- File: `src/dbt_to_lookml/schemas/config.py`
- Add to `__all__` exports
- Use `Optional` for Pydantic compatibility
- Follow existing ConfigMeta patterns

## Success Criteria

- [ ] PopConfig model validates enabled, grains, comparisons, windows, format, date_dimension, date_filter
- [ ] PopGrain, PopComparison, and PopWindow enums defined
- [ ] ConfigMeta extended with pop field
- [ ] windows defaults to `[month]` when not specified
- [ ] date_filter defaults to `{date_dimension}_date` when not specified
- [ ] Unit tests for PopConfig validation
- [ ] Test default values and optional fields
- [ ] Test invalid grain/comparison/window values raise ValidationError
- [ ] Test field resolution logic (date_filter, windows)

## Links

- Epic: [DTL-037](./../epics/DTL-037.md)
- Strategy: [.tasks/strategies/DTL-038-strategy.md](./../strategies/DTL-038-strategy.md)
- Spec: [.tasks/specs/DTL-038-spec.md](./../specs/DTL-038-spec.md)

## History

### 2025-12-15 19:30 - Issue Created
Created from epic DTL-037
