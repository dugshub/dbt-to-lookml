---
id: DTL-026
title: "Update explore generation for metric requirements"
type: feature
status: ready
labels:
  - stack:backend
  - type:feature
  - priority:high
  - state:has-spec
parent: DTL-022
created: 2025-11-18T00:00:00Z
updated: 2025-11-18T00:00:00Z
---

# DTL-026: Update explore generation for metric requirements

## Description

Modify explore join generation to expose measures required by cross-entity metrics while maintaining `dimensions_only*` for other fields.

## What needs to be built

### Explore Analysis

**Identify Metric Requirements**:
```python
def _identify_metric_requirements(
    self,
    base_model: SemanticModel,
    metrics: list[Metric],
    all_models: list[SemanticModel]
) -> dict[str, set[str]]:
    """
    For a given explore base model, determine which measures from joined views
    are needed by cross-entity metrics.

    Returns: {
        "rental_orders": {"rental_count", "total_revenue"},
        "users": {"user_count"}
    }
    """
```

### Join Field Exposure Enhancement

**Current Logic** (from DTL-001):
```python
join["fields"] = [f"{target_view_name}.dimensions_only*"]
```

**Enhanced Logic**:
```python
# Base: dimensions only
fields = [f"{target_view_name}.dimensions_only*"]

# Add required measures for cross-entity metrics
if target_view_name in metric_requirements:
    for measure_name in metric_requirements[target_view_name]:
        fields.append(f"{target_view_name}.{measure_name}")

join["fields"] = fields
```

### Example Output

**Before** (DTL-001):
```lookml
join: rental_orders {
  sql_on: ${searches.search_sk} = ${rental_orders.search_sk} ;;
  relationship: one_to_many
  type: left_outer
  fields: [rental_orders.dimensions_only*]
}
```

**After** (with metrics):
```lookml
join: rental_orders {
  sql_on: ${searches.search_sk} = ${rental_orders.search_sk} ;;
  relationship: one_to_many
  type: left_outer
  fields: [
    rental_orders.dimensions_only*,
    rental_orders.rental_count,
    rental_orders.total_revenue
  ]
}
```

### Edge Cases

- **Base explore view measures**: Don't add to required_fields (same view)
- **Multi-hop joins**: Ensure intermediate joins also expose required measures
- **No metrics using a join**: Keep `dimensions_only*` only
- **Measure already exposed**: Don't duplicate in fields list
- **View prefix**: Handle prefixed view names correctly

## Why it's needed (connection to epic)

Makes cross-view measures available in explores so `required_fields` can reference them. Without this, the cross-entity metrics would fail at query time.

## Technical scope from labels

Backend work in `src/dbt_to_lookml/generators/lookml.py`:
- Modify `_build_join_graph()` method
- Add metric requirements analysis
- Update fields parameter generation
- Maintain backward compatibility with non-metric generation
- Ensure deterministic output (sorted fields for testing)

## Acceptance Criteria

- [ ] `_identify_metric_requirements()` correctly finds required measures
- [ ] Join fields include `dimensions_only*` plus required measures
- [ ] Base view measures not included in required_fields
- [ ] Multi-hop joins expose required measures
- [ ] No duplicate measures in fields list
- [ ] Empty case handled (no metrics â†’ dimensions_only only)
- [ ] View prefix applied correctly to field names
- [ ] Fields list is deterministic/sorted for testing

## Testing requirements

**Unit tests** (in `src/tests/unit/test_lookml_generator.py`):
- Test `_identify_metric_requirements()` with various metrics
- Test join fields with no metrics (dimensions_only only)
- Test join fields with one metric requiring one measure
- Test join fields with multiple metrics requiring same measure
- Test join fields with metrics requiring multiple measures
- Test multi-hop join scenarios
- Test that base view measures are excluded
- Test view prefix handling
- Test deterministic output (fields list order)

**Test fixtures**:
- Semantic models: searches, rental_orders, users
- Metrics: search_conversion_rate (searches base, needs rental_count)
- Metrics: engagement_score (users base, needs rental_count + search_count)

**Integration tests** (in `src/tests/integration/`):
- End-to-end test: Generate explores with metric requirements
- Verify generated LookML syntax is valid
- Verify all required measures exposed in joins

**Coverage target**: 95%+ branch coverage

## Dependencies

- DTL-023 (needs Metric schema models)
- DTL-024 (needs parsed metrics)
- DTL-025 (needs to know what measures metrics require)

## Blocked by

- DTL-023
- DTL-024
- DTL-025

## Blocks

- DTL-028 (integration tests need this)

## Links
- Epic: [DTL-022](./../epics/DTL-022.md)
- Depends on: [DTL-023](./../issues/DTL-023.md), [DTL-024](./../issues/DTL-024.md), [DTL-025](./../issues/DTL-025.md)
- Implementation plan: .tasks/plans/cross-entity-metrics-plan.yaml
- Implementation strategy: [DTL-026-strategy.md](./../strategies/DTL-026-strategy.md)

## Notes

### Algorithm for Identifying Requirements

```python
def _identify_metric_requirements(
    self,
    base_model: SemanticModel,
    metrics: list[Metric],
    all_models: list[SemanticModel]
) -> dict[str, set[str]]:
    requirements: dict[str, set[str]] = {}

    # Get metrics owned by this explore
    owned_metrics = [
        m for m in metrics
        if m.primary_entity == base_model.primary_entity.name
    ]

    for metric in owned_metrics:
        # Extract all measure dependencies
        measure_deps = extract_measure_dependencies(metric)

        for measure_name in measure_deps:
            # Find which model contains this measure
            model = find_model_for_measure(measure_name, all_models)

            # Skip if same model (no cross-view reference needed)
            if model.name == base_model.name:
                continue

            # Add to requirements
            if model.name not in requirements:
                requirements[model.name] = set()
            requirements[model.name].add(measure_name)

    return requirements
```

### Example Scenario

**Setup**:
- Base explore: `searches`
- Metric: `search_conversion_rate` (primary_entity: search)
  - Numerator: `rental_count` (from rental_orders)
  - Denominator: `search_count` (from searches)

**Result**:
```python
requirements = {
    "rental_orders": {"rental_count"}
}
# search_count excluded (same model as base)
```

**Generated Join**:
```lookml
join: rental_orders {
  fields: [
    rental_orders.dimensions_only*,
    rental_orders.rental_count
  ]
}
```

## History
### 2025-11-18 00:00 - Issue Created
Created from epic DTL-022

### 2025-11-18 - Implementation Strategy Created
Comprehensive implementation strategy completed and saved to .tasks/strategies/DTL-026-strategy.md. Key architectural decisions documented:
- Metric analysis performed within _build_join_graph() at explore generation time
- Optional metrics parameter added to maintain backward compatibility
- Algorithm designed to identify required measures and enhance join fields lists
- Full test coverage strategy with 95%+ target
- All edge cases identified and handling approach defined

### 2025-11-18 - Implementation Spec Generated
Detailed implementation spec created at .tasks/specs/DTL-026-spec.md covering:
- 6 detailed implementation tasks with file locations and code patterns
- Comprehensive unit test plan with 14 test cases
- Integration test strategy with fixtures
- Edge case handling for 6 scenarios
- Mock patterns for testing metric requirements
- Complete validation commands
- Ready for implementation (estimated 10-14 hours)

Status updated to "ready" with state:has-spec label.
