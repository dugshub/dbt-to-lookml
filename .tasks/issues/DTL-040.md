---
id: DTL-040
title: "Generate PoP date dimensions"
type: feature
status: refinement
labels:
  - stack:backend
  - type:feature
  - priority:high
created: 2025-12-15T19:30:00Z
updated: 2025-12-15T19:30:00Z
parent: DTL-037
---

# DTL-040: Generate PoP date dimensions

## Problem Statement

Generate LookML yesno dimensions for PoP date filtering.

## What to Build

Generate hidden yesno dimensions that filter data for each grain and comparison:
- `is_mtd`: Current month-to-date
- `is_ytd`: Current year-to-date
- `is_prior_period`: Same period offset by 1 period (uses templated date filter)
- `is_prior_year`: Same period offset by 1 year (uses templated date filter)
- Combined variants: `is_mtd_prior_period`, `is_mtd_prior_year`, etc.

### Integration with Existing d2l Date Infrastructure

These dimensions must reference the **existing d2l-generated date selection dimension**, not a hardcoded field. The date dimension name comes from:
1. Explicit `pop.date_dimension` in config
2. Else semantic model's `defaults.agg_time_dimension`

This ensures PoP works with d2l's existing date selection parameter (e.g., user picks "Created Date" vs "Start Date").

### Prior Period: Parameter-Driven Window

"Prior Period" offset is controlled by the `period_window` parameter (week/month/quarter). This ensures the label "Prior Period" accurately describes what's being compared.

### Prior Period/Year: Templated Filters

Prior period and prior year dimensions need the user's selected date range to calculate offsets. Use Looker templated filters:
- `{% date_start <filter_field> %}` - Start of user's date selection
- `{% date_end <filter_field> %}` - End of user's date selection
- `{% parameter period_window %}` - The selected period window (week/month/quarter)

The filter field comes from `pop.date_filter` (or defaults to `{date_dimension}_date`).

## Example Output

```lookml
# Grain dimensions (static, relative to CURRENT_DATE)
dimension: is_mtd {
  hidden: yes
  type: yesno
  sql: ${selected_date_raw} >= DATE_TRUNC('month', CURRENT_DATE) ;;
}

dimension: is_ytd {
  hidden: yes
  type: yesno
  sql: ${selected_date_raw} >= DATE_TRUNC('year', CURRENT_DATE) ;;
}

# Comparison dimensions (dynamic, relative to user's date filter AND period_window parameter)
dimension: is_prior_period {
  hidden: yes
  type: yesno
  sql: ${selected_date_raw} BETWEEN
       DATEADD({% parameter period_window %}, -1, {% date_start selected_date_date %})
       AND DATEADD({% parameter period_window %}, -1, {% date_end selected_date_date %}) ;;
}

dimension: is_prior_year {
  hidden: yes
  type: yesno
  sql: ${selected_date_raw} BETWEEN
       DATEADD('year', -1, {% date_start selected_date_date %})
       AND DATEADD('year', -1, {% date_end selected_date_date %}) ;;
}

# Combined: MTD of prior period (uses period_window parameter)
dimension: is_mtd_prior_period {
  hidden: yes
  type: yesno
  sql: ${selected_date_raw} >= DATEADD({% parameter period_window %}, -1, DATE_TRUNC('month', CURRENT_DATE))
       AND ${selected_date_raw} <= DATEADD({% parameter period_window %}, -1, CURRENT_DATE) ;;
}

# Combined: MTD of prior year (always 1 year offset)
dimension: is_mtd_prior_year {
  hidden: yes
  type: yesno
  sql: ${selected_date_raw} >= DATEADD('year', -1, DATE_TRUNC('month', CURRENT_DATE))
       AND ${selected_date_raw} <= DATEADD('year', -1, CURRENT_DATE) ;;
}
```

## Why It's Needed

These dimensions act as filters on hidden measures to isolate data for specific
time periods. They're the building blocks for PoP calculations.

## Technical Scope

- File: `src/dbt_to_lookml/generators/lookml.py`
- New method: `_generate_pop_dimensions()`
- Resolve date_dimension from pop config or model defaults
- Resolve date_filter from pop config or derive from date_dimension
- Use Looker templated filters (`{% date_start %}`, `{% date_end %}`) for prior period/year
- Use `{% parameter period_window %}` for prior period offset (week/month/quarter)
- Only generate dimensions for configured grains/comparisons

## Success Criteria

- [ ] Dimension SQL correct for each grain type (mtd, ytd)
- [ ] Dimension SQL correct for each comparison type (pp, py)
- [ ] Prior period uses `{% parameter period_window %}` for dynamic offset
- [ ] Combined grain x comparison dimensions generated (is_mtd_pp, is_mtd_py, is_ytd_pp, is_ytd_py)
- [ ] Correct date_dimension reference in SQL (from pop config or model defaults)
- [ ] Correct date_filter reference in templated filters
- [ ] All dimensions hidden by default
- [ ] Works with d2l's existing date selection infrastructure

## Links

- Epic: [DTL-037](./../epics/DTL-037.md)
- Strategy: [.tasks/strategies/DTL-040-strategy.md](./../strategies/DTL-040-strategy.md)
- Spec: [.tasks/specs/DTL-040-spec.md](./../specs/DTL-040-spec.md)

## History

### 2025-12-15 19:30 - Issue Created
Created from epic DTL-037
