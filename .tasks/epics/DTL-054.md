---
id: DTL-054
title: "Epic: PoP Support for Same-Model Derived Metrics"
type: epic
status: refinement
labels:
  - stack:backend
  - type:epic
  - priority:medium
created: 2025-12-22T23:00:00Z
updated: 2025-12-22T23:00:00Z
children:
  - DTL-055
  - DTL-056
  - DTL-057
  - DTL-058
---

# DTL-054: Epic: PoP Support for Same-Model Derived Metrics

## Problem Statement

dbt-to-lookml generates Period-over-Period (PoP) variants for simple metrics but silently
skips derived metrics entirely. This is a significant gap because many meaningful business
metrics are derived (e.g., `net_change = gained - lost`).

From a dbt semantic layer perspective, derived metrics maintain semantic abstraction and
preserve metric lineage. Users should not have to flatten derived metrics to simple metrics
just to get PoP support.

**Example:**
```yaml
metrics:
  - name: net_change_eom
    type: derived
    type_params:
      expr: gained - lost
      metrics:
        - name: gained_eom    # simple metric on facility_monthly_status
        - name: lost_eom      # simple metric on facility_monthly_status
    meta:
      primary_entity: facility
      pop:
        enabled: true
        comparisons: [py, pp]
        windows: [month]
```

This derived metric currently gets NO PoP variants, even with `pop.enabled: true`.

## Solution Approach

When a derived metric meets these criteria, it qualifies for PoP generation:
- All parent metrics recursively resolve to `type: simple` metrics
- All parent metrics share the same `primary_entity` (same semantic model)
- The derived expression uses supported arithmetic operations

For qualifying derived metrics with `pop.enabled`, generate `period_over_period` measures
using Looker's native PoP (which supports `type: number` measures when they reference
aggregate measures).

## Technical Validation

Looker's `period_over_period` documentation confirms that `type: number` measures ARE
supported for `based_on` when they reference aggregate measures. Since derived metrics
with all-simple parents meet this criterion, native PoP should work.

## Success Criteria

- [ ] Derived metrics with `pop.enabled` generate PoP variants when all parents are simple metrics on same model
- [ ] Nested derived metrics (derived -> derived -> simple) are recursively resolved
- [ ] Cross-model derived metrics are gracefully skipped (current behavior preserved)
- [ ] Documentation updated to reflect new capability
- [ ] Test coverage includes all edge cases

## Sub-Issues

- [DTL-055: Add same-model detection utility for derived metrics](./../issues/DTL-055.md)
- [DTL-056: Update PoP generation to include qualifying derived metrics](./../issues/DTL-056.md)
- [DTL-057: Add comprehensive test coverage for derived metric PoP](./../issues/DTL-057.md)
- [DTL-058: Update documentation for derived metric PoP support](./../issues/DTL-058.md)

## Links

- Plan: .tasks/plans/issue-plan-derived-metric-pop.yaml

## History

### 2025-12-22 23:00 - Epic Created
Created from plan: .tasks/plans/issue-plan-derived-metric-pop.yaml
