---
id: DTL-022
title: "Epic: Implement Cross-Entity Metrics Support"
type: epic
status: refinement
labels:
  - stack:backend
  - type:epic
  - priority:high
created: 2025-11-18T00:00:00Z
updated: 2025-11-18T00:00:00Z
children:
  - DTL-023
  - DTL-024
  - DTL-025
  - DTL-026
  - DTL-027
  - DTL-028
---

# DTL-022: Epic: Implement Cross-Entity Metrics Support

## Problem Statement

dbt semantic layer defines metrics that can span multiple entities (semantic models). For example:
- `search_conversion_rate = rental_count / search_count` combines measures from rental_orders and searches
- `revenue_per_user = total_revenue / user_count` combines measures from rental_orders and users

Currently, dbt-to-lookml only converts semantic models to LookML views. Metrics that span multiple entities cannot be represented in the generated LookML.

## Solution Approach

Implement metric parsing and generation with **primary entity ownership** pattern:

1. **Parse dbt metrics** from `metrics/*.yml` files with `meta.primary_entity` declaration
2. **Assign metric ownership** to the appropriate semantic model/explore based on primary entity
3. **Generate cross-view measures** in the primary entity's view file using `${other_view.measure}` references
4. **Use required_fields** parameter to auto-activate joins when cross-entity metrics are selected
5. **Expose required measures** in join definitions via selective fields parameter
6. **Validate connectivity** to ensure all required measures are reachable via join graph

### Key Principle: Primary Entity Ownership

Every metric has a **primary entity** that determines:
- Which view file contains the generated measure
- Which explore serves as the base/spine for the calculation
- What the "universe" of the denominator represents

**Example**:
```yaml
metrics:
  - name: search_conversion_rate
    type: ratio
    type_params:
      numerator: rental_count    # From rental_orders
      denominator: search_count  # From searches
    meta:
      primary_entity: search     # Searches is the spine (need full search universe)
```

**Generated in `searches.view.lkml`**:
```lookml
measure: search_conversion_rate {
  type: number
  sql: 1.0 * ${rental_orders.rental_count} / NULLIF(${search_count}, 0) ;;
  required_fields: [rental_orders.rental_count]
  value_format_name: percent_2
  view_label: " Metrics"
  group_label: "Search Performance"
}
```

**Explore enhancement**:
```lookml
explore: searches {
  join: rental_orders {
    fields: [
      rental_orders.dimensions_only*,
      rental_orders.rental_count  # ‚Üê Exposed for cross-entity metric
    ]
  }
}
```

## Success Criteria

- [ ] Parser successfully reads dbt metric YAML files
- [ ] Metrics with explicit `meta.primary_entity` generate in correct view
- [ ] Metrics without explicit primary_entity infer from denominator (ratio type)
- [ ] Generated measures use `required_fields` for automatic join activation
- [ ] Explore join definitions expose required measures
- [ ] Validation detects unreachable measures and provides clear errors
- [ ] All tests pass with 95%+ branch coverage
- [ ] Integration tests verify end-to-end metric generation
- [ ] Documentation explains primary entity ownership pattern

## Technical Architecture

### New Components

1. **Metric Schema Models** (`schemas.py`) - DTL-023
2. **Metric Parser** (`parsers/dbt_metrics.py`) - DTL-024
3. **Cross-Entity Measure Generator** (`generators/lookml.py`) - DTL-025
4. **Explore Enhancer** (`generators/lookml.py`) - DTL-026
5. **Entity Connectivity Validator** (`validation/`) - DTL-027
6. **Comprehensive Tests** (`tests/`) - DTL-028

### Modified Components

1. **CLI** (`__main__.py`) - Add `--metrics-dir` parameter
2. **LookMLGenerator** (`generators/lookml.py`) - Accept metrics as input

## Sub-Issues

- [DTL-023: Add Metric schema models to schemas.py](./../issues/DTL-023.md) - üìã refinement
- [DTL-024: Implement dbt metrics YAML parser](./../issues/DTL-024.md) - üìã refinement
- [DTL-025: Add cross-entity measure generation to LookMLGenerator](./../issues/DTL-025.md) - üìã refinement
- [DTL-026: Update explore generation for metric requirements](./../issues/DTL-026.md) - üìã refinement
- [DTL-027: Add entity connectivity validation](./../issues/DTL-027.md) - üìã refinement
- [DTL-028: Add comprehensive tests for cross-entity metrics](./../issues/DTL-028.md) - üìã refinement

## Links
- Plan: .tasks/plans/cross-entity-metrics-plan.yaml

## History
### 2025-11-18 00:00 - Epic Created
Created from plan: .tasks/plans/cross-entity-metrics-plan.yaml
