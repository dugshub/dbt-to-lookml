---
id: DTL-037
title: "Epic: PoP (Period-over-Period) and Grain-to-Date Support"
type: epic
status: refinement
labels:
  - stack:backend
  - type:epic
  - priority:high
created: 2025-12-15T19:30:00Z
updated: 2025-12-15T19:30:00Z
children:
  - DTL-038
  - DTL-039
  - DTL-040
  - DTL-041
  - DTL-042
  - DTL-043
  - DTL-044
  - DTL-045
---

# DTL-037: Epic: PoP (Period-over-Period) and Grain-to-Date Support

## Problem Statement

Business users need to compare metrics across time periods (MTD vs prior month, YTD vs prior year)
without manually creating dozens of filtered measures. Currently, every comparison requires
hand-crafted LookML measures, leading to view files with hundreds of lines of repetitive code.

## Solution Approach

Implement a PoP (Period-over-Period) feature that:
1. Parses `pop` configuration from dbt measure meta blocks
2. Auto-generates PoP date filter dimensions (is_mtd, is_ytd, is_prior_period, etc.)
3. Creates global parameters for period grain and comparison selection
4. Generates hidden measures for each grain x comparison combination
5. Creates visible measure groups with current, comparison, delta, and % change

The feature auto-detects PoP configuration from meta - no CLI flag required. It uses the
semantic model's `defaults.agg_time_dimension` as the date reference for PoP calculations.

## Success Criteria

- [ ] Measures with `pop.enabled: true` in meta generate complete PoP measure groups
- [ ] Only configured grains (mtd, ytd) and comparisons (pp, py) generate measures
- [ ] Generated LookML integrates with existing date selection infrastructure
- [ ] 95%+ test coverage on new PoP functionality
- [ ] Type-safe implementation passing mypy --strict

## Configuration Example

### Measure-Level Config
```yaml
measures:
  - name: revenue
    agg: sum
    expr: checkout_amount
    config:
      meta:
        pop:
          enabled: true
          grains: [mtd, ytd]           # Which grain variants to generate
          comparisons: [pp, py]         # Which comparison variants to generate
          windows: [week, month, quarter] # What "Prior Period" can mean
          format: usd                   # LookML value_format_name
          date_dimension: selected_date # Optional: Override date dimension
          date_filter: selected_date_date # Optional: Override filter for {% date_start/end %}
```

### Model-Level Defaults
```yaml
semantic_model:
  name: rentals
  defaults:
    agg_time_dimension: selected_date  # d2l uses this for date selection
  config:
    meta:
      pop:
        date_dimension: selected_date  # All measures inherit this
        windows: [month]               # Default period window
```

### The Three Dimensions of PoP

| Parameter | Purpose | Values |
|-----------|---------|--------|
| `period_window` | What's a "period"? | week, month, quarter |
| `period_grain` | Use filter as-is or to-date? | selected, mtd, ytd |
| `comparison_period` | Compare to what? | pp (prior period), py (prior year) |

### Why Partial Period Comparison Matters

When reporting on **partial periods** (MTD/YTD), you must compare to the **same slice** of the comparison period for apples-to-apples comparison:

```
Today: Dec 15, 2024

MTD (current):        Dec 1-15, 2024
MTD + Prior Period:   Nov 1-15, 2024  (not full Nov!)
MTD + Prior Year:     Dec 1-15, 2023  (not full Dec 2023!)
```

This is why combined dimensions like `is_mtd_prior_period` exist.

### Field Resolution
1. `date_dimension`: Use pop config → model config → `defaults.agg_time_dimension`
2. `date_filter`: Use pop config → derive as `{date_dimension}_date`
3. `windows`: Use pop config → model config → default `[month]`

## Out of Scope (Phase 2+)

- Generic metric selector for single-KPI widgets
- WoW/MoM/QoQ shortcuts
- Custom offset windows

## Sub-Issues

- [DTL-038: Add PoP configuration schema](./../issues/DTL-038.md) - refinement
- [DTL-039: Parse pop meta from measures](./../issues/DTL-039.md) - refinement
- [DTL-040: Generate PoP date dimensions](./../issues/DTL-040.md) - refinement
- [DTL-041: Generate PoP global parameters](./../issues/DTL-041.md) - refinement
- [DTL-042: Generate hidden PoP measures](./../issues/DTL-042.md) - refinement
- [DTL-043: Generate visible PoP measure group](./../issues/DTL-043.md) - refinement
- [DTL-044: Wire PoP into generation pipeline](./../issues/DTL-044.md) - refinement
- [DTL-045: Add PoP test suite](./../issues/DTL-045.md) - refinement

## Links

- Plan: .tasks/plans/issue-plan-pop-period-over-period.yaml

## History

### 2025-12-15 19:30 - Epic Created
Created from plan: .tasks/plans/issue-plan-pop-period-over-period.yaml
