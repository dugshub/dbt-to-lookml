epic:
  title: "Epic: Wizard, Help, and LLM Prompt Updates for SpotHero Workflow"
  description: |
    ## Problem Statement
    The dbt-to-lookml tool has evolved significantly with features like `--bi-field-only`,
    `--fact-models`, `--use-group-item-label`, and timezone conversion options. However, the
    wizard, help documentation, and configuration management haven't kept pace. Team members
    cannot easily reproduce the standard SpotHero workflow without manually constructing
    complex commands with absolute paths.

    ## Solution Approach
    1. Update the wizard to support ALL current generate command flags with SpotHero-appropriate defaults
    2. Create project-level configuration (`.d2l.yaml`) to store project-specific settings
    3. Update CLI help text to reflect best practices and common workflows
    4. Create an LLM prompt command that outputs comprehensive tool documentation for Claude Code
    5. Document gotchas and recent behavioral changes

    ## Success Criteria
    - [ ] Wizard supports all generate flags (`--bi-field-only`, `--fact-models`, `--use-group-item-label`, etc.)
    - [ ] Project config file (`.d2l.yaml`) allows setting defaults without absolute paths
    - [ ] Teammates can clone repos, run wizard, and get SpotHero-appropriate defaults
    - [ ] `/llm-prompt` command outputs comprehensive tool documentation
    - [ ] Help text reflects current features and workflows
    - [ ] Gotchas documented in CLAUDE.md

    ## Sub-Issues
    1. DTL-026: Update wizard with missing flags and SpotHero defaults
    2. DTL-027: Implement project-level configuration (`.d2l.yaml`)
    3. DTL-028: Create LLM prompt command for Claude Code integration
    4. DTL-029: Update CLI help text and examples
    5. DTL-030: Document gotchas and behavioral considerations

  labels: [type:epic, stack:backend, priority:high]
  status: Refinement
  children:
    - title: "Update wizard with all generate flags and smart defaults"
      description: |
        ## What Needs To Be Built
        Update `GenerateWizard` in `wizard/generate_wizard.py` to support ALL current generate command flags:
        - `--bi-field-only` (checkbox, recommend enabled for SpotHero workflow)
        - `--fact-models` (text input with comma-separated model names)
        - `--use-group-item-label` (checkbox, recommend enabled)
        - `--time-dimension-group-label` (text input, default "Time Dimensions")

        ## Why It's Needed
        The wizard is the primary onboarding path for new team members. Without full flag support,
        users must manually construct complex commands, leading to inconsistency and errors.

        ## Technical Scope
        - Extend `GenerateWizardConfig` dataclass with new fields
        - Add prompts for each new option in `GenerateWizard.run()`
        - Update `to_command_parts()` and `to_command_string()` methods
        - Update wizard execution to pass all parameters to generate command
        - Update default values to match SpotHero workflow

        ## Testing Requirements
        - Unit tests for new prompts and config fields
        - Integration test for full wizard flow with new options
        - Test command string generation includes all flags

      labels: [type:feature, stack:backend, priority:high]
      status: Refinement

    - title: "Implement project-level configuration (.d2l.yaml)"
      description: |
        ## What Needs To Be Built
        Create a project configuration system that allows storing defaults in `.d2l.yaml`:

        ```yaml
        # .d2l.yaml - Project-level dbt-to-lookml configuration
        version: "1.0"

        # Input/output paths (relative to project root)
        input_dir: "../spothero-dbt-silver/redshift_gold/models/3_semantic"
        output_dir: "./GoldLayer"

        # Generation settings
        schema: gold_production
        view_prefix: gold_
        explore_prefix: gold_
        model_name: gold_semantic_models
        connection: redshift_test

        # Feature flags
        bi_field_only: true
        use_group_item_label: true
        convert_tz: false
        time_dimension_group_label: "Time Dimensions"

        # Fact models for explore generation
        fact_models:
          - rentals
        ```

        ## Why It's Needed
        - Removes absolute paths from commands
        - Teammates can clone repos and run with project-appropriate defaults
        - Configuration is versioned with the project
        - Supports cross-repo workflows (semantic models in one repo, LookML in another)

        ## Technical Scope
        - Create `ProjectConfig` Pydantic model in `src/dbt_to_lookml/project_config.py`
        - Implement config discovery (walk up from cwd to find `.d2l.yaml`)
        - Update CLI to load and merge project config with command-line args
        - Update wizard to use project config as defaults
        - Add `d2l init` command to create template `.d2l.yaml`

        ## Testing Requirements
        - Unit tests for config loading and validation
        - Test config precedence (CLI > project config > defaults)
        - Test config discovery in nested directories
        - Test relative path resolution

      labels: [type:feature, stack:backend, priority:high]
      status: Refinement

    - title: "Create LLM prompt command for Claude Code integration"
      description: |
        ## What Needs To Be Built
        Create a command `d2l llm-prompt` that outputs comprehensive tool documentation
        formatted for LLM consumption. This enables Claude Code to understand the tool
        deeply when working on semantic models or LookML generation.

        Output should include:
        - Tool overview and purpose
        - All CLI commands and flags with descriptions
        - Key concepts (semantic models, measures vs metrics, bi_field filtering)
        - Common workflows and examples
        - Gotchas and behavioral notes
        - SpotHero-specific usage patterns

        ## Why It's Needed
        When team members use Claude Code on semantic model or LookML tasks, the LLM
        needs comprehensive context about dbt-to-lookml to provide accurate guidance.
        Rather than relying on CLAUDE.md alone, this command generates a focused prompt.

        ## Technical Scope
        - Create `LLMPromptGenerator` class in `src/dbt_to_lookml/llm_prompt.py`
        - Add `d2l llm-prompt` CLI command
        - Support output formats: `--format markdown` (default), `--format json`
        - Include version and timestamp in output
        - Pull documentation from docstrings, CLI help, and embedded content

        ## Testing Requirements
        - Unit test for prompt generation
        - Verify all commands documented
        - Test different output formats

      labels: [type:feature, stack:backend, priority:medium]
      status: Refinement

    - title: "Update CLI help text and examples"
      description: |
        ## What Needs To Be Built
        Update help text across all CLI commands to reflect:
        - Current feature set (bi_field, fact_models, group_item_label)
        - SpotHero workflow patterns
        - Common gotchas and tips
        - Better examples showing real-world usage

        ## Why It's Needed
        Help text is often the first documentation users see. Current help is basic
        and doesn't showcase the power of the tool or warn about common pitfalls.

        ## Technical Scope
        - Update `cli` group help in `__main__.py`
        - Update `generate` command help with comprehensive examples
        - Update `wizard generate` help
        - Add tip sections for common workflows
        - Include warnings about required flags (e.g., `--fact-models` for explores)

        ## Testing Requirements
        - CLI tests verify help text contains key information
        - Snapshot tests for help output

      labels: [type:chore, stack:backend, priority:medium]
      status: Refinement

    - title: "Document gotchas and behavioral considerations in CLAUDE.md"
      description: |
        ## What Needs To Be Built
        Add a "Gotchas and Behavioral Notes" section to CLAUDE.md documenting:

        1. **Measure Naming and Hiding**
           - All dbt measures get `_measure` suffix (e.g., `revenue` â†’ `revenue_measure`)
           - All dbt measures are hidden by default (building blocks for metrics)
           - Use dbt metrics for user-facing measures in Looker

        2. **bi_field Filtering Behavior**
           - Only fields with `config.meta.bi_field: true` appear in explores
           - Metric dependencies are automatically included BUT hidden if not tagged
           - Primary keys always included (for joins)

        3. **Explore Generation Requirements**
           - `--fact-models` flag is REQUIRED to generate explores
           - Without it, only view files are generated
           - Fact models define which semantic models become explores

        4. **Field Picker Sort Order**
           - Labels with leading spaces sort first in Looker
           - Measures have 2-space prefix for grouping
           - Can control sort order via label prefixes

        5. **config.meta Nesting**
           - Must use `config.meta.bi_field`, not `meta.bi_field`
           - Follows dbt standard nesting pattern

        ## Why It's Needed
        Team members repeatedly encounter these behaviors and need a reference.
        LLMs also need this context to provide accurate guidance.

        ## Technical Scope
        - Add "Gotchas and Behavioral Notes" section to CLAUDE.md
        - Include code examples for each gotcha
        - Cross-reference relevant source files

        ## Testing Requirements
        - Review accuracy of documented behavior
        - Verify examples match actual output

      labels: [type:chore, stack:backend, priority:medium]
      status: Refinement
