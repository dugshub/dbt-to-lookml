epic:
  title: "Epic: Implement field exposure control for explore joins"
  description: |
    ## Problem Statement

    Currently, when explores join dimensional views, both dimensions AND measures from those views are exposed in the field picker. This creates incorrect analytics because measures from joined dimensional views only aggregate over the filtered/joined subset, not the entire dimension table.

    For example, when joining `dim_searches` to `fct_rentals` through `search_sk`, the explore exposes search measures (count, sum, etc.) that only count searches associated with rentals, not all searches. This is misleading because Looker uses the rental table as the spine, so only searches with rental associations appear in the results.

    ## Solution Approach

    Implement field exposure control using LookML field sets and the `fields` parameter in joins:

    1. **Generate dimension-only field sets**: Create `set: dimensions_only` in all view files containing all dimensions (including hidden ones, which may be needed for joins)
    2. **Constrain join field exposure**: Use `fields: [view.dimensions_only*]` in all explore join definitions to limit exposed fields to dimensions only
    3. **Exclude measures from joins**: Measures remain only in the base fact explore view, preventing incorrect aggregations

    This approach follows the principle that measures should only be aggregated from the base/spine table of an explore. Future enhancements will include:
    - dbt-configured dimension sets for granular control
    - Looker METRICS pattern for cross-view metric definitions
    - Configurable field exposure per join

    ## Success Criteria

    - All views generate a `set: dimensions_only` containing all dimension fields
    - All explore joins include `fields: [view.dimensions_only*]` parameter
    - Dimensional view measures no longer appear in fact table explores
    - Existing tests pass with updated explore structure
    - Golden tests reflect new explore join structure with field constraints

    ## Sub-Issues

    1. Add LookML set support to schemas (foundation)
    2. Generate dimension-only field sets in views (implementation)
    3. Update join generation with fields parameter (implementation)
    4. Update unit tests for field sets and joins (testing)
    5. Update integration and golden tests (testing)

  labels:
    - stack:backend
    - type:epic
    - priority:high
  status: Refinement

  children:
    - title: "Add LookML set support to schemas"
      description: |
        Extend the Pydantic schema models to support LookML field sets, which are used to group fields for reuse in explores and joins.

        ## What needs to be built

        - Add `LookMLSet` Pydantic model to `schemas.py` representing a LookML `set:` block
        - Add optional `sets: List[LookMLSet]` field to `LookMLView` model
        - Update `LookMLView.to_lookml_dict()` to include sets in output dictionary
        - Ensure sets appear after sql_table_name but before dimensions in generated LookML

        ## Why it's needed (connection to epic)

        Sets are the foundation for field exposure control in explores. This schema support enables the generator to create and reference dimension-only sets in join definitions.

        ## Technical scope from labels

        Backend work in `src/dbt_to_lookml/schemas.py`:
        - Add new Pydantic models with full type hints (mypy --strict compliance)
        - Maintain backward compatibility (sets are optional)
        - Follow existing schema patterns (BaseModel, Optional fields, to_lookml_dict methods)

        ## Testing requirements

        - Unit tests for LookMLSet model validation
        - Unit tests for LookMLView.to_lookml_dict() with sets
        - Verify sets serialize correctly to LookML format

        Parent: Epic: Implement field exposure control for explore joins

      labels:
        - stack:backend
        - type:feature
        - priority:high
      status: Refinement

    - title: "Generate dimension-only field sets in views"
      description: |
        Implement automatic generation of `set: dimensions_only` in all view files, containing references to all dimension fields (including hidden entities).

        ## What needs to be built

        - Add `_generate_dimension_set()` method to `LookMLGenerator` class
        - Collect all dimension names from a `SemanticModel` (entities + dimensions)
        - Create `LookMLSet(name="dimensions_only", fields=[...])` with all dimension names
        - Update `_generate_view_lookml()` to include the generated set in view output
        - Include hidden entity dimensions in the set (needed for join keys)

        ## Why it's needed (connection to epic)

        This implements the core mechanism for constraining field exposure. The dimension-only set will be referenced in explore joins to prevent measures from dimensional views appearing in fact explores.

        ## Technical scope from labels

        Backend work in `src/dbt_to_lookml/generators/lookml.py`:
        - Add set generation logic to LookMLGenerator
        - Integrate with existing view generation pipeline
        - Maintain existing view structure (entities → dimensions → measures)
        - Ensure sets are positioned correctly in LookML output

        ## Testing requirements

        - Unit tests for _generate_dimension_set() method
        - Verify all dimensions (including hidden) are included
        - Test set appears in correct position in generated LookML
        - Ensure empty sets are handled gracefully (views with no dimensions)

        Parent: Epic: Implement field exposure control for explore joins

      labels:
        - stack:backend
        - type:feature
        - priority:high
      status: Refinement

    - title: "Update join generation with fields parameter"
      description: |
        Modify explore join generation to include `fields: [view.dimensions_only*]` parameter, constraining exposed fields to dimensions only.

        ## What needs to be built

        - Update `_build_join_graph()` method to add `fields` parameter to join dictionaries
        - Set `fields: ["{view_name}.dimensions_only*"]` for each join
        - Update `_generate_explores_lookml()` to include fields in join LookML output
        - Ensure fields parameter appears in correct position (after relationship, before type)

        ## Why it's needed (connection to epic)

        This completes the field exposure control by using the dimension-only sets in join definitions. Without this, measures from joined views would still appear in explores.

        ## Technical scope from labels

        Backend work in `src/dbt_to_lookml/generators/lookml.py`:
        - Modify join generation logic in _build_join_graph()
        - Update join dictionary structure to include fields parameter
        - Ensure lkml library correctly serializes fields parameter
        - Maintain existing join functionality (sql_on, relationship, type)

        ## Testing requirements

        - Unit tests for _build_join_graph() with fields parameter
        - Verify fields parameter uses correct view name and wildcard syntax
        - Test multi-hop joins include fields on all join levels
        - Ensure joins without sets gracefully handle missing field references

        Parent: Epic: Implement field exposure control for explore joins

      labels:
        - stack:backend
        - type:feature
        - priority:high
      status: Refinement

    - title: "Update unit tests for field sets and joins"
      description: |
        Update unit tests in `src/tests/unit/` to cover new field set generation and join field constraints.

        ## What needs to be built

        - Add tests to `test_lookml_generator.py` for dimension set generation
        - Add tests for join fields parameter in explore generation
        - Update existing test fixtures to expect sets in view output
        - Update existing join tests to expect fields parameter
        - Test edge cases: views with no dimensions, hidden-only dimensions, multi-hop joins with fields

        ## Why it's needed (connection to epic)

        Unit tests ensure the field exposure control logic works correctly in isolation and maintains code coverage targets (95% branch coverage).

        ## Technical scope from labels

        Backend testing work in `src/tests/unit/`:
        - Add test cases to test_lookml_generator.py
        - Update test fixtures and expected outputs
        - Maintain 95% branch coverage target
        - Follow pytest conventions and use parametrize for variations

        ## Testing requirements

        - All new methods have corresponding unit tests
        - Edge cases are covered (empty sets, hidden fields, etc.)
        - Tests use clear arrange-act-assert structure
        - Run with `make test-fast` for quick validation

        Parent: Epic: Implement field exposure control for explore joins

      labels:
        - stack:backend
        - type:feature
        - priority:medium
      status: Refinement

    - title: "Update integration and golden tests"
      description: |
        Update end-to-end tests to verify field exposure control works correctly with real semantic models and matches expected LookML output.

        ## What needs to be built

        - Update golden test expected outputs in `src/tests/golden/expected_output/` to include sets and join fields
        - Add integration test cases for field exposure scenarios
        - Update test fixtures in `src/tests/fixtures/` if needed for new scenarios
        - Verify explores only show dimensions from joined views, not measures
        - Test multi-hop join scenarios maintain field constraints through the chain

        ## Why it's needed (connection to epic)

        Integration and golden tests provide end-to-end validation that field exposure control works correctly with real-world semantic models and produces correct LookML output.

        ## Technical scope from labels

        Backend testing work in `src/tests/`:
        - Update integration tests (test_integration.py)
        - Update golden tests (test_golden.py)
        - Regenerate expected output files
        - Maintain test isolation and determinism

        ## Testing requirements

        - Golden tests pass with updated expected output
        - Integration tests verify end-to-end functionality
        - Test coverage remains at 95%+ branch coverage
        - Run with `make test-full` for comprehensive validation

        Parent: Epic: Implement field exposure control for explore joins

      labels:
        - stack:backend
        - type:feature
        - priority:medium
      status: Refinement
