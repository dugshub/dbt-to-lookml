epic:
  title: "Epic: Add configurable timezone conversion for LookML dimension_groups"
  description: |
    ## Problem Statement

    Currently, timezone conversion behavior in generated LookML is implicit, relying on Looker's default behavior (`convert_tz: yes`). This means timestamps are automatically converted from the database timezone to the user's viewing timezone. Users need explicit control over this behavior at multiple configuration levels (CLI flags, generator parameters, and per-dimension metadata) with a sensible default that prevents unexpected timezone conversions.

    ## Solution Approach

    Implement a multi-level configuration system for timezone conversion:

    1. **Schema Layer** - Add `convert_tz` support to the `Dimension` model's `_to_dimension_group_dict` method
    2. **Generator Layer** - Add `convert_tz` parameter to `LookMLGenerator` with propagation to dimension generation
    3. **CLI Layer** - Add `--convert-tz` / `--no-convert-tz` flags to the generate command
    4. **Metadata Layer** - Support per-dimension override via `config.meta.convert_tz` in semantic model YAML

    **Precedence (highest to lowest)**:
    - Per-dimension metadata (`config.meta.convert_tz`)
    - Generator parameter (`LookMLGenerator(convert_tz=...)`)
    - CLI flag (`--convert-tz` / `--no-convert-tz`)
    - Default (`convert_tz: no` - disable timezone conversion by default)

    ## Success Criteria

    - ✅ CLI supports `--convert-tz` and `--no-convert-tz` flags
    - ✅ `LookMLGenerator.__init__()` accepts `convert_tz: bool | None` parameter
    - ✅ Dimensions can override via `config.meta.convert_tz: yes|no` in YAML
    - ✅ Default behavior is `convert_tz: no` (explicit in generated LookML)
    - ✅ Precedence chain works correctly (dimension meta > generator > CLI > default)
    - ✅ All existing tests pass without modification
    - ✅ New unit tests validate all configuration levels
    - ✅ Golden files updated to reflect `convert_tz: no` in dimension_groups
    - ✅ mypy strict typing maintained (no type errors)
    - ✅ 95%+ branch coverage maintained

    ## Sub-Issues

    1. Update Dimension schema to support convert_tz parameter
    2. Update LookMLGenerator to accept and propagate convert_tz settings
    3. Add CLI flags for timezone conversion control
    4. Add comprehensive unit tests for timezone conversion
    5. Update integration and golden tests
    6. Update documentation for timezone conversion feature
  labels:
    - stack:backend
    - type:epic
    - priority:high
  status: Refinement
  children:
    - title: "Update Dimension schema to support convert_tz parameter"
      description: |
        Modify the `Dimension` class in `src/dbt_to_lookml/schemas.py` to support timezone conversion configuration:

        **Tasks**:
        1. Add optional `convert_tz` field to `Dimension` model (type: `bool | None`)
        2. Update `_to_dimension_group_dict()` method to:
           - Accept optional `default_convert_tz` parameter (for propagating generator/CLI defaults)
           - Check for dimension-level override in `config.meta.convert_tz`
           - Apply precedence: dimension meta > default_convert_tz parameter > hardcoded default (False)
           - Add `convert_tz: yes|no` to the returned dictionary for dimension_groups
        3. Update `Config` and `Meta` models if needed to support `convert_tz` in metadata
        4. Ensure mypy strict typing compliance

        **Files to modify**:
        - `src/dbt_to_lookml/schemas.py` (Dimension, Config, Meta classes)

        **Testing**:
        - Unit tests in `test_schemas.py` to validate convert_tz handling
        - Test precedence: meta override > default parameter > hardcoded default

        **Acceptance Criteria**:
        - Dimension._to_dimension_group_dict() accepts default_convert_tz parameter
        - Dimension can read convert_tz from config.meta.convert_tz
        - Precedence chain works correctly
        - Type hints are correct and mypy passes

        Parent: Epic: Add configurable timezone conversion for LookML dimension_groups
      labels:
        - stack:backend
        - type:feature
        - layer:atoms
        - priority:high
      status: Refinement

    - title: "Update LookMLGenerator to accept and propagate convert_tz settings"
      description: |
        Modify the `LookMLGenerator` class in `src/dbt_to_lookml/generators/lookml.py` to support timezone conversion configuration and propagate it to dimension generation:

        **Tasks**:
        1. Add `convert_tz: bool | None = None` parameter to `LookMLGenerator.__init__()`
        2. Store the convert_tz setting as an instance variable
        3. Update `_generate_view_lookml()` to pass convert_tz to semantic model's `to_lookml_dict()`
        4. Update `SemanticModel.to_lookml_dict()` to accept `convert_tz` and pass it to dimension conversion
        5. Ensure backward compatibility (None = use default behavior)

        **Files to modify**:
        - `src/dbt_to_lookml/generators/lookml.py` (LookMLGenerator class)
        - `src/dbt_to_lookml/schemas.py` (SemanticModel.to_lookml_dict method)

        **Testing**:
        - Unit tests in `test_lookml_generator.py` to validate convert_tz propagation
        - Test that generator parameter overrides default but not dimension meta

        **Acceptance Criteria**:
        - LookMLGenerator accepts convert_tz parameter
        - convert_tz is correctly propagated to dimension generation
        - Backward compatibility maintained (existing code works)
        - Type hints correct and mypy passes

        Parent: Epic: Add configurable timezone conversion for LookML dimension_groups
      labels:
        - stack:backend
        - type:feature
        - layer:features
        - priority:high
      status: Refinement

    - title: "Add CLI flags for timezone conversion control"
      description: |
        Add `--convert-tz` and `--no-convert-tz` flags to the `generate` command in the CLI to allow users to control timezone conversion from the command line:

        **Tasks**:
        1. Add mutually exclusive `--convert-tz` / `--no-convert-tz` flags to generate command in `src/dbt_to_lookml/__main__.py`
        2. Default behavior when neither flag is provided: `convert_tz=None` (use generator default, which is False)
        3. Pass the flag value to `LookMLGenerator` constructor
        4. Update CLI help text to document the flags and default behavior
        5. Ensure validate and format commands are not affected (they don't generate LookML)

        **Files to modify**:
        - `src/dbt_to_lookml/__main__.py` (generate command)

        **Testing**:
        - CLI tests in `test_cli.py` to validate flags work correctly
        - Test `--convert-tz` sets convert_tz=True
        - Test `--no-convert-tz` sets convert_tz=False
        - Test neither flag uses default (None)

        **Acceptance Criteria**:
        - `--convert-tz` flag sets convert_tz=True
        - `--no-convert-tz` flag sets convert_tz=False
        - Flags are mutually exclusive (Click validation)
        - Help text is clear and accurate
        - CLI tests pass

        Parent: Epic: Add configurable timezone conversion for LookML dimension_groups
      labels:
        - stack:backend
        - type:feature
        - layer:features
        - priority:high
      status: Refinement

    - title: "Add comprehensive unit tests for timezone conversion"
      description: |
        Create comprehensive unit tests to validate timezone conversion behavior at all configuration levels (dimension meta, generator parameter, CLI flag, default):

        **Tasks**:
        1. Add tests in `test_schemas.py` for Dimension convert_tz handling:
           - Test dimension with convert_tz=True in meta
           - Test dimension with convert_tz=False in meta
           - Test dimension with no convert_tz (uses default)
           - Test precedence: meta > default_convert_tz parameter
        2. Add tests in `test_lookml_generator.py` for generator propagation:
           - Test LookMLGenerator with convert_tz=True
           - Test LookMLGenerator with convert_tz=False
           - Test LookMLGenerator with convert_tz=None (default)
           - Test dimension meta override of generator setting
        3. Add tests in `test_cli.py` for CLI flags:
           - Test `--convert-tz` flag
           - Test `--no-convert-tz` flag
           - Test no flag (uses default)
        4. Ensure all tests validate the actual LookML output contains correct `convert_tz` value

        **Files to modify**:
        - `src/tests/unit/test_schemas.py`
        - `src/tests/unit/test_lookml_generator.py`
        - `src/tests/test_cli.py`

        **Acceptance Criteria**:
        - All new tests pass
        - Branch coverage remains at 95%+
        - Tests cover all precedence scenarios
        - Tests validate actual LookML output

        Parent: Epic: Add configurable timezone conversion for LookML dimension_groups
      labels:
        - stack:backend
        - type:feature
        - priority:high
      status: Refinement

    - title: "Update integration and golden tests"
      description: |
        Update integration tests and golden files to reflect the new default behavior (`convert_tz: no`) in generated LookML dimension_groups:

        **Tasks**:
        1. Update golden files in `src/tests/golden/`:
           - Add `convert_tz: no` to all dimension_group blocks in expected_*.view.lkml files
           - Run golden test to regenerate expected output
        2. Update integration tests if needed:
           - Ensure end-to-end tests still pass
           - Add integration test for convert_tz configuration flow
        3. Run full test suite to ensure no regressions:
           - `make test-full` should pass
           - Coverage should remain at 95%+

        **Files to modify**:
        - `src/tests/golden/expected_searches.view.lkml`
        - `src/tests/golden/expected_rental_orders.view.lkml`
        - Any other golden files with dimension_groups
        - `src/tests/integration/test_end_to_end.py` (if needed)

        **Acceptance Criteria**:
        - All golden tests pass with updated expected output
        - Integration tests pass
        - Full test suite passes (`make test-full`)
        - Coverage at 95%+

        Parent: Epic: Add configurable timezone conversion for LookML dimension_groups
      labels:
        - stack:backend
        - type:feature
        - priority:medium
      status: Refinement

    - title: "Update documentation for timezone conversion feature"
      description: |
        Update project documentation to explain the new timezone conversion configuration feature:

        **Tasks**:
        1. Update CLAUDE.md to document:
           - New convert_tz configuration options
           - Precedence chain (dimension meta > generator > CLI > default)
           - Default behavior (convert_tz: no)
           - Examples of usage at each level
        2. Update CLI help text (already done in CLI task, verify here)
        3. Add docstring examples to relevant classes/methods:
           - Dimension._to_dimension_group_dict()
           - LookMLGenerator.__init__()
        4. Consider adding a brief note to README.md if appropriate

        **Files to modify**:
        - `CLAUDE.md`
        - Possibly `README.md`
        - Docstrings in `src/dbt_to_lookml/schemas.py`
        - Docstrings in `src/dbt_to_lookml/generators/lookml.py`

        **Acceptance Criteria**:
        - CLAUDE.md has comprehensive section on timezone conversion
        - Examples are clear and accurate
        - Docstrings are updated with type hints and examples
        - Documentation follows Google-style docstring format

        Parent: Epic: Add configurable timezone conversion for LookML dimension_groups
      labels:
        - stack:backend
        - type:chore
        - priority:low
      status: Refinement
