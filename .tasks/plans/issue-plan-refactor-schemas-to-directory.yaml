epic:
  title: "Epic: Refactor schemas.py into system-aligned modules (dbt semantic layer + Looker)"
  description: |
    ## Problem
    The 966-line schemas.py file mixes input (dbt semantic layer) and output (Looker/LookML) system schemas,
    making it unclear which schemas belong to which system. Semantic models and metrics are both part of dbt's
    semantic layer specification but appear separated in the current structure. This monolithic file makes
    navigation difficult and requires loading all schemas regardless of which domain is needed.

    ## Solution
    Split schemas.py into 3 focused modules within a schemas/ directory, aligned with the two systems:
    - schemas/config.py - Shared configuration schemas (Hierarchy, ConfigMeta, Config)
    - schemas/semantic_layer.py - dbt semantic layer schemas (Entity, Dimension, Measure, SemanticModel,
      Metric, MetricReference, *MetricParams)
    - schemas/lookml.py - Looker/LookML output schemas (LookMLDimension, LookMLDimensionGroup, LookMLMeasure,
      LookMLSet, LookMLView, LookMLExplore)

    Maintain backward compatibility via schemas/__init__.py re-exports with deprecation warnings to guide
    gradual migration.

    ## Success Criteria
    - ✅ All schemas organized by system (dbt semantic layer vs Looker)
    - ✅ Existing imports (from dbt_to_lookml.schemas import X) work unchanged
    - ✅ Full test suite passes (make test-full)
    - ✅ 95%+ coverage maintained across all schema modules
    - ✅ Deprecation warnings guide users to new import paths

    ## Sub-Issues
    - DTL-TBD-1: Create schemas directory structure
    - DTL-TBD-2: Extract config schemas to schemas/config.py
    - DTL-TBD-3: Extract dbt semantic layer schemas
    - DTL-TBD-4: Extract LookML schemas to schemas/lookml.py
    - DTL-TBD-5: Implement backward compatibility layer
    - DTL-TBD-6: Update internal imports to new structure
    - DTL-TBD-7: Verify tests and coverage
  labels:
    - stack:backend
    - type:epic
    - priority:medium
  status: Refinement

  children:
    - title: "Create schemas directory structure with __init__.py framework"
      description: |
        Set up the schemas/ directory as a Python package and create the __init__.py file with the framework
        for re-exporting all schema classes. This provides the foundation for backward compatibility.

        ## Tasks
        - Create src/dbt_to_lookml/schemas/ directory
        - Create empty schemas/__init__.py with module docstring
        - Add __all__ list placeholder for re-exports
        - Ensure schemas/ is recognized as a package

        ## Testing
        - Verify directory is importable: `python -c "import dbt_to_lookml.schemas"`
        - Confirm package structure with pytest discovery

        Parent: Epic - Refactor schemas.py into system-aligned modules
      labels:
        - stack:backend
        - type:chore
        - priority:medium
      status: Refinement

    - title: "Extract config schemas to schemas/config.py"
      description: |
        Move shared configuration schemas (Hierarchy, ConfigMeta, Config) from schemas.py to schemas/config.py.
        These are used by both semantic layer and LookML schemas and should remain independent.

        ## Schemas to Extract
        - Hierarchy (lines 17-23)
        - ConfigMeta (lines 25-86)
        - Config (lines 88-92)

        ## Tasks
        - Create schemas/config.py with module docstring
        - Copy Hierarchy, ConfigMeta, Config classes with full docstrings
        - Add __all__ = ["Hierarchy", "ConfigMeta", "Config"]
        - Verify imports (BaseModel from pydantic)
        - Add unit tests for config schemas if missing

        ## Testing
        - Import test: `from dbt_to_lookml.schemas.config import Hierarchy, ConfigMeta, Config`
        - Run existing tests that use these classes
        - Verify 95%+ branch coverage for config.py

        Parent: Epic - Refactor schemas.py into system-aligned modules
      labels:
        - stack:backend
        - type:feature
        - priority:medium
      status: Refinement

    - title: "Extract dbt semantic layer schemas to schemas/semantic_layer.py"
      description: |
        Move all dbt semantic layer input schemas (semantic models and metrics) from schemas.py to
        schemas/semantic_layer.py. This consolidates the dbt semantic layer specification into one module.

        ## Schemas to Extract
        **Semantic Models**:
        - Entity (lines 94-166)
        - Dimension (lines 168-366)
        - Measure (lines 368-451)
        - SemanticModel (lines 453-582)

        **Metrics**:
        - MetricReference (lines 589-618)
        - SimpleMetricParams (lines 620-639)
        - RatioMetricParams (lines 641-664)
        - DerivedMetricParams (lines 666-693)
        - ConversionMetricParams (lines 695-720)
        - Metric (lines 722-832)

        ## Tasks
        - Create schemas/semantic_layer.py with comprehensive module docstring
        - Copy all Entity, Dimension, Measure, SemanticModel classes
        - Copy all metric-related classes (MetricReference, *MetricParams, Metric)
        - Import Config from schemas.config
        - Import types from dbt_to_lookml.types (LOOKML_TYPE_MAP, AggregationType, DimensionType)
        - Add __all__ list with all exported classes
        - Preserve all docstrings and implementation logic

        ## Testing
        - Import test: `from dbt_to_lookml.schemas.semantic_layer import SemanticModel, Metric`
        - Run test_schemas.py unit tests
        - Run test_dbt_parser.py and test_dbt_metric_parser.py
        - Verify 95%+ branch coverage for semantic_layer.py

        Parent: Epic - Refactor schemas.py into system-aligned modules
      labels:
        - stack:backend
        - type:feature
        - priority:high
      status: Refinement

    - title: "Extract LookML schemas to schemas/lookml.py"
      description: |
        Move all LookML output schemas from schemas.py to schemas/lookml.py. These represent Looker-specific
        output structures generated by the LookML generator.

        ## Schemas to Extract
        - LookMLDimension (lines 839-851)
        - LookMLDimensionGroup (lines 853-867)
        - LookMLMeasure (lines 869-880)
        - LookMLSet (lines 882-887)
        - LookMLView (lines 889-953)
        - LookMLExplore (lines 955-966)

        ## Tasks
        - Create schemas/lookml.py with module docstring describing LookML output schemas
        - Copy all LookML* classes with full docstrings
        - Ensure BaseModel imports from pydantic
        - Add __all__ list with all exported classes
        - Preserve to_lookml_dict() methods and helper functions

        ## Testing
        - Import test: `from dbt_to_lookml.schemas.lookml import LookMLView, LookMLExplore`
        - Run test_lookml_generator.py tests
        - Verify 95%+ branch coverage for lookml.py

        Parent: Epic - Refactor schemas.py into system-aligned modules
      labels:
        - stack:backend
        - type:feature
        - priority:medium
      status: Refinement

    - title: "Implement backward compatibility in schemas/__init__.py"
      description: |
        Set up schemas/__init__.py to re-export all schema classes from the new modules, maintaining backward
        compatibility with existing imports. Add deprecation warnings to guide users toward the new import paths.

        ## Tasks
        - Import all classes from schemas.config, schemas.semantic_layer, schemas.lookml
        - Re-export via __all__ to maintain `from dbt_to_lookml.schemas import X` imports
        - Add module-level docstring explaining the new structure
        - Add deprecation warnings using warnings.warn() for imports from __init__.py
        - Include migration guide in docstring showing old vs new import paths

        ## Example Deprecation
        ```python
        import warnings
        from dbt_to_lookml.schemas.config import *
        from dbt_to_lookml.schemas.semantic_layer import *
        from dbt_to_lookml.schemas.lookml import *

        warnings.warn(
            "Importing from dbt_to_lookml.schemas is deprecated. "
            "Use specific modules: dbt_to_lookml.schemas.config, "
            "dbt_to_lookml.schemas.semantic_layer, or dbt_to_lookml.schemas.lookml",
            DeprecationWarning,
            stacklevel=2
        )
        ```

        ## Testing
        - Verify old imports work: `from dbt_to_lookml.schemas import SemanticModel`
        - Confirm deprecation warnings are raised
        - Run full test suite to ensure no import breakage

        Parent: Epic - Refactor schemas.py into system-aligned modules
      labels:
        - stack:backend
        - type:feature
        - priority:high
      status: Refinement

    - title: "Update internal imports to use new structure"
      description: |
        Migrate all internal imports (parsers, generators, validators, tests) from the old schemas.py to the
        new modular structure. Use specific module imports instead of the deprecated __init__.py re-exports.

        ## Files to Update (27 files using schemas)
        **Parsers**:
        - src/dbt_to_lookml/parsers/dbt.py
        - src/dbt_to_lookml/parsers/dbt_metrics.py

        **Generators**:
        - src/dbt_to_lookml/generators/lookml.py

        **Validators**:
        - src/dbt_to_lookml/validation.py

        **Interfaces**:
        - src/dbt_to_lookml/interfaces/generator.py

        **Tests** (22 test files):
        - src/tests/unit/test_schemas.py
        - src/tests/unit/test_dbt_parser.py
        - src/tests/unit/test_dbt_metric_parser.py
        - src/tests/unit/test_lookml_generator.py
        - src/tests/unit/test_lookml_generator_metrics.py
        - src/tests/unit/test_validation.py
        - src/tests/unit/test_hierarchy.py
        - src/tests/unit/test_flat_meta.py
        - src/tests/test_error_handling.py
        - src/tests/test_performance.py
        - src/tests/integration/test_metric_validation.py
        - (and others)

        ## Import Pattern
        Old: `from dbt_to_lookml.schemas import SemanticModel, Dimension`
        New: `from dbt_to_lookml.schemas.semantic_layer import SemanticModel, Dimension`

        ## Tasks
        - Update parsers to import from schemas.semantic_layer
        - Update generators to import from schemas.lookml
        - Update validators to import from appropriate modules
        - Update all test files to use new import paths
        - Remove old schemas.py file after migration complete

        ## Testing
        - Run make lint to check for issues
        - Run make type-check to verify mypy compliance
        - Run make test-full to ensure all tests pass

        Parent: Epic - Refactor schemas.py into system-aligned modules
      labels:
        - stack:backend
        - type:chore
        - priority:high
      status: Refinement

    - title: "Verify tests and coverage after schema refactoring"
      description: |
        Run comprehensive test suite and coverage analysis to ensure the schema refactoring maintains 95%+
        branch coverage and all tests pass. Fix any issues discovered during testing.

        ## Testing Steps
        1. Run make test-full (all test suites)
        2. Run make test-coverage (generate coverage report)
        3. Review htmlcov/index.html for each schema module
        4. Run make quality-gate (lint + types + tests)
        5. Fix any failing tests or coverage gaps

        ## Coverage Targets
        - schemas/config.py: 95%+ branch coverage
        - schemas/semantic_layer.py: 95%+ branch coverage
        - schemas/lookml.py: 95%+ branch coverage
        - schemas/__init__.py: 100% coverage (simple re-exports)

        ## Success Criteria
        - ✅ All tests pass (make test-full)
        - ✅ 95%+ branch coverage for all schema modules
        - ✅ make quality-gate passes (lint + types + tests)
        - ✅ No regressions in existing functionality
        - ✅ Deprecation warnings appear but don't break tests

        ## If Issues Found
        - Document failing tests and root cause
        - Fix import errors or missing dependencies
        - Add missing tests for uncovered branches
        - Re-run until all criteria met

        Parent: Epic - Refactor schemas.py into system-aligned modules
      labels:
        - stack:backend
        - type:chore
        - priority:high
      status: Refinement
