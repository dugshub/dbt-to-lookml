epic:
  title: "Epic: PoP Support for Same-Model Derived Metrics"
  description: |
    ## Problem Statement

    dbt-to-lookml generates Period-over-Period (PoP) variants for simple metrics but silently
    skips derived metrics entirely. This is a significant gap because many meaningful business
    metrics are derived (e.g., `net_change = gained - lost`).

    From a dbt semantic layer perspective, derived metrics maintain semantic abstraction and
    preserve metric lineage. Users should not have to flatten derived metrics to simple metrics
    just to get PoP support.

    ## Solution Approach

    When a derived metric meets these criteria, it qualifies for PoP generation:
    - All parent metrics recursively resolve to `type: simple` metrics
    - All parent metrics share the same `primary_entity` (same semantic model)
    - The derived expression uses supported arithmetic operations

    For qualifying derived metrics with `pop.enabled`, generate `period_over_period` measures
    using Looker's native PoP (which supports `type: number` measures when they reference
    aggregate measures).

    ## Success Criteria
    - Derived metrics with `pop.enabled` generate PoP variants when all parents are simple metrics on same model
    - Nested derived metrics (derived -> derived -> simple) are recursively resolved
    - Cross-model derived metrics are gracefully skipped (current behavior preserved)
    - Documentation updated to reflect new capability
    - Test coverage includes all edge cases

    ## Sub-Issues
    1. Add same-model detection utility for derived metrics
    2. Update PoP generation to include qualifying derived metrics
    3. Add comprehensive test coverage
    4. Update documentation
  labels: [type:epic, stack:backend, priority:medium]
  status: refinement
  children:
    - title: "Add same-model detection utility for derived metrics"
      description: |
        Create a utility function to detect if a derived metric qualifies for PoP generation.

        ## What to Build
        Add a function (likely in `generators/lookml.py` or a new utility module) that:
        1. Takes a metric and list of all metrics
        2. Recursively traverses `type_params.metrics` for derived metrics
        3. Checks that ALL leaf metrics are `type: simple`
        4. Verifies all parent metrics share the same `primary_entity`
        5. Returns a tuple: `(qualifies: bool, parent_metric_names: list[str])`

        ## Technical Details
        - Handle nested derived metrics: derived -> derived -> simple
        - Detect and handle circular references gracefully (return False)
        - Consider caching for metrics checked multiple times
        - Should work with the existing Metric and SemanticModel schemas

        ## Testing Requirements
        - Unit tests for simple qualifying cases
        - Unit tests for nested derived metrics
        - Unit tests for cross-model cases (should return False)
        - Unit tests for edge cases (missing parent, circular ref)

        Parent: Epic: PoP Support for Same-Model Derived Metrics
      labels: [type:feature, stack:backend, layer:atoms]
      status: refinement

    - title: "Update PoP generation to include qualifying derived metrics"
      description: |
        Modify the PoP generation flow to include derived metrics that pass the same-model check.

        ## What to Build
        Update `_generate_metric_pop_measures` and related code in `generators/lookml.py`:
        1. Before generating PoP for a metric, check if it's a derived metric
        2. If derived, run the same-model detection utility
        3. If qualifying, proceed with `period_over_period` generation using `based_on: metric_name`
        4. If not qualifying, skip silently (preserve current behavior for cross-model)

        ## Technical Details
        - The derived metric's LookML measure is `type: number` with SQL like `${parent_a} - ${parent_b}`
        - Looker's `period_over_period` supports `type: number` as `based_on` when it references aggregates
        - Use the same PoP generation pattern as simple metrics: previous, difference, relative_change
        - Inherit PoP config from the derived metric's `meta.pop` settings

        ## Integration Points
        - Depends on same-model detection utility from previous sub-issue
        - Uses existing `_generate_metric_pop_measures` infrastructure
        - Works with both measure-level and metric-level PoP flows

        ## Testing Requirements
        - Integration test: derived metric generates PoP variants
        - Integration test: nested derived metric generates PoP variants
        - Integration test: cross-model derived metric is skipped
        - Verify generated LookML is valid and parseable

        Parent: Epic: PoP Support for Same-Model Derived Metrics
      labels: [type:feature, stack:backend, layer:features]
      status: refinement

    - title: "Add comprehensive test coverage for derived metric PoP"
      description: |
        Create thorough test coverage for the derived metric PoP feature.

        ## What to Build
        Add tests in `tests/unit/` covering:

        ### Same-Model Detection Tests
        - `test_same_model_detection_simple_parents`: All parents simple on same model -> True
        - `test_same_model_detection_nested_derived`: derived -> derived -> simple -> True
        - `test_same_model_detection_cross_model`: Parents on different models -> False
        - `test_same_model_detection_mixed_types`: Some parents not simple -> False
        - `test_same_model_detection_circular_ref`: Circular reference -> False
        - `test_same_model_detection_missing_parent`: Parent metric not found -> False

        ### PoP Generation Tests
        - `test_derived_metric_pop_generation`: Verify PoP measures created for qualifying metric
        - `test_derived_metric_pop_labels`: Verify labels match simple metric pattern
        - `test_derived_metric_pop_config_inheritance`: PoP config (windows, comparisons) inherited
        - `test_derived_metric_pop_skipped_cross_model`: Cross-model derived skipped silently
        - `test_derived_metric_pop_with_date_selector`: Works with date_selector enabled

        ### Integration Tests
        - End-to-end test with real semantic model fixture containing derived metric with PoP
        - Verify generated LookML is syntactically valid

        Parent: Epic: PoP Support for Same-Model Derived Metrics
      labels: [type:feature, stack:backend, layer:features, tdd:true]
      status: refinement

    - title: "Update documentation for derived metric PoP support"
      description: |
        Update project documentation to reflect the new derived metric PoP capability.

        ## What to Update

        ### CLAUDE.md
        - Update the "Period-over-Period (PoP) on Metrics" section
        - Remove or update the "Limitation" note about ratio/derived metrics
        - Add example of derived metric with PoP config

        ### .claude/ai-docs/conversion-rules.md
        - Add section on derived metric PoP support
        - Document the "same-model" qualification criteria
        - Include before/after LookML examples

        ## Documentation Content
        - Explain qualifying criteria (all parents simple, same model)
        - Show example YAML for derived metric with pop.enabled
        - Show expected LookML output
        - Note that cross-model derived metrics are still unsupported

        Parent: Epic: PoP Support for Same-Model Derived Metrics
      labels: [type:chore, stack:backend]
      status: refinement
