epic:
  title: "Epic: Metrics Support and Field Visibility Control"
  description: |
    ## Problem Statement

    The dbt-to-lookml tool currently only supports semantic model YAML files and lacks control over field visibility in generated LookML. This creates three critical gaps:

    1. **No metrics file support**: Standalone dbt metrics files (with `metrics:` top-level key) are ignored, forcing users to embed metrics in semantic model files
    2. **No visibility control**: All dimensions and measures are exposed in LookML with no way to hide internal/technical fields
    3. **No opt-in mechanism**: No way to selectively expose fields for BI tools while automatically including dependencies

    ## Solution Approach

    Implement comprehensive metrics support and field visibility control through:

    1. **Metrics schema and parsing**: Add Pydantic models for dbt metrics (simple and derived types) and extend DbtParser to handle standalone metrics files alongside semantic models
    2. **Hidden parameter**: Add `config.meta.hidden` boolean to ConfigMeta, respected by dimension/measure LookML generation to exclude fields from display
    3. **bi_field opt-in**: Add `config.meta.bi_field` boolean to ConfigMeta for selective field exposure with intelligent dependency resolution that automatically includes required measures (marked as hidden) even if not tagged as bi_field

    ## Success Criteria

    - ✅ Parse standalone metrics YAML files (both simple and derived metrics)
    - ✅ Convert dbt metrics to LookML measures with proper aggregation types
    - ✅ Respect `hidden: true` in field metadata to exclude from LookML display
    - ✅ Support `bi_field: true` opt-in mechanism for selective field exposure
    - ✅ Automatically include metric dependencies (measures) even if not marked as bi_field, with hidden: yes
    - ✅ Maintain backward compatibility (existing behavior unchanged when new fields not used)
    - ✅ 95%+ test coverage across all new features
    - ✅ Full type safety with mypy strict mode

    ## Sub-Issues

    1. Add dbt metrics schema models (DTL-022)
    2. Extend parser to support standalone metrics files (DTL-023)
    3. Implement hidden parameter support for fields (DTL-024)
    4. Implement bi_field opt-in mechanism (DTL-025)
    5. Implement dependency resolution for bi_field (DTL-026)
    6. Add comprehensive tests for metrics and visibility features (DTL-027)
    7. Update documentation for metrics and visibility support (DTL-028)
  labels:
    - stack:backend
    - type:epic
    - layer:features
    - priority:high
  status: Refinement
  children:
    - title: "Add dbt metrics schema models"
      description: |
        Create Pydantic schema models to represent dbt metrics structures (simple and derived types).

        ## Scope

        Add to `src/dbt_to_lookml/schemas.py`:
        - `MetricType` enum with values: SIMPLE, DERIVED, RATIO, CUMULATIVE
        - `MetricTypeParams` base class for type-specific parameters
        - `SimpleMetricTypeParams` for simple metrics (references a measure)
        - `DerivedMetricTypeParams` for derived metrics (expression + metric references)
        - `MetricInput` class for metric references with optional aliases and offset windows
        - `Metric` base class with common fields (name, type, label, description, config)

        Add to `src/dbt_to_lookml/types.py`:
        - Update `LOOKML_TYPE_MAP` if needed for metric-specific aggregations

        ## Technical Requirements

        - Use Pydantic BaseModel with strict validation
        - Support both `meta:` metadata (hierarchy, domain, etc.)
        - Include `to_lookml_dict()` method on Metric to convert to LookML measure format
        - Handle metric dependencies (track which measures/metrics a metric depends on)
        - Maintain backward compatibility with existing schemas

        ## Testing

        - Unit tests for each schema class instantiation
        - Validation tests for required fields
        - Test `to_lookml_dict()` conversion for simple and derived metrics
        - Test metric dependency tracking

        Parent: DTL-021
      labels:
        - stack:backend
        - type:feature
        - layer:atoms
        - priority:high
      status: Refinement

    - title: "Extend parser to support standalone metrics files"
      description: |
        Modify DbtParser to detect and parse standalone metrics YAML files alongside semantic model files.

        ## Scope

        Modify `src/dbt_to_lookml/parsers/dbt.py`:
        - Update `parse_file()` to detect both `semantic_models:` and `metrics:` top-level keys
        - Add `_parse_metric()` method to parse individual metric definitions
        - Add `_parse_metrics_list()` to handle list of metrics
        - Update `parse_directory()` to handle mixed files (some with semantic models, some with metrics)
        - Link metrics to their corresponding semantic models via metadata (e.g., `meta.primary_entity`)

        ## Technical Requirements

        - Support parsing files with ONLY `metrics:` key (no semantic_models)
        - Support parsing files with BOTH `semantic_models:` and `metrics:` keys
        - Graceful error handling for invalid metric structures
        - Respect `strict_mode` for metric parsing errors
        - Log warnings for metrics that reference undefined measures

        ## Testing

        - Unit tests for parsing simple metrics files
        - Unit tests for parsing derived metrics files
        - Integration tests for mixed semantic model + metrics files
        - Error handling tests for malformed metrics
        - Tests for strict_mode vs lenient mode behavior

        Parent: DTL-021
      labels:
        - stack:backend
        - type:feature
        - layer:features
        - priority:high
      status: Refinement

    - title: "Implement hidden parameter support for fields"
      description: |
        Add support for `config.meta.hidden` boolean to control field visibility in generated LookML.

        ## Scope

        Modify `src/dbt_to_lookml/schemas.py`:
        - Add `hidden: bool | None` field to `ConfigMeta` class
        - Update `Dimension._to_dimension_dict()` to check `config.meta.hidden` and add `hidden: yes` to LookML output
        - Update `Dimension._to_dimension_group_dict()` to check `config.meta.hidden` and add `hidden: yes` to LookML output
        - Update `Measure.to_lookml_dict()` to check `config.meta.hidden` and add `hidden: yes` to LookML output
        - Update `Metric.to_lookml_dict()` (from DTL-022) to check `config.meta.hidden` and add `hidden: yes` to LookML output

        ## Technical Requirements

        - Default behavior: `hidden` is None → no hidden parameter in LookML (existing behavior)
        - When `hidden: true` in YAML metadata → `hidden: yes` in LookML
        - When `hidden: false` in YAML metadata → no hidden parameter in LookML (explicit visibility)
        - Entities already have `hidden: yes` by default (don't change this)
        - Maintain backward compatibility (no hidden field = no change to output)

        ## Testing

        - Unit tests for dimension with hidden: true
        - Unit tests for dimension_group (time dimension) with hidden: true
        - Unit tests for measure with hidden: true
        - Unit tests for metric with hidden: true
        - Golden tests comparing LookML output with/without hidden parameter
        - Verify entities still have hidden: yes by default

        Parent: DTL-021
      labels:
        - stack:backend
        - type:feature
        - layer:features
        - priority:high
      status: Refinement

    - title: "Implement bi_field opt-in mechanism"
      description: |
        Add support for `config.meta.bi_field` boolean to selectively expose fields in generated LookML explores.

        ## Scope

        Modify `src/dbt_to_lookml/schemas.py`:
        - Add `bi_field: bool | None` field to `ConfigMeta` class

        Modify `src/dbt_to_lookml/generators/lookml.py`:
        - Add `use_bi_field_filter: bool` parameter to `LookMLGenerator.__init__()` (default: False for backward compatibility)
        - When `use_bi_field_filter=True`, filter dimensions/measures/metrics in explore generation to only include fields with `bi_field: true`
        - Primary keys (entities) should always be included regardless of bi_field setting (required for joins)
        - Track which fields are included for dependency resolution (next issue)

        Add CLI flag:
        - Modify `src/dbt_to_lookml/__main__.py` to add `--bi-field-only` flag to generate command
        - Pass flag value to LookMLGenerator constructor

        ## Technical Requirements

        - Default behavior: `use_bi_field_filter=False` → all fields included (existing behavior)
        - When `use_bi_field_filter=True` + field has `bi_field: true` → field included in explore
        - When `use_bi_field_filter=True` + field missing bi_field or `bi_field: false` → field excluded from explore
        - Primary keys always included (required for join relationships)
        - Field filtering applies only to explore fields parameter, not to view definitions
        - Maintain backward compatibility (no flag = existing behavior)

        ## Testing

        - Unit tests for bi_field filtering in LookMLGenerator
        - Test that primary keys always included
        - Test explore fields parameter contains only bi_field: true fields
        - CLI tests for --bi-field-only flag
        - Golden tests for explore output with bi_field filtering

        Parent: DTL-021
      labels:
        - stack:backend
        - type:feature
        - layer:features
        - priority:high
      status: Refinement

    - title: "Implement dependency resolution for bi_field"
      description: |
        Automatically include required measures in explores even if not marked as bi_field, to ensure metrics work correctly.

        ## Scope

        Modify `src/dbt_to_lookml/generators/lookml.py`:
        - Add dependency tracking: for each metric marked `bi_field: true`, track which measures it depends on
        - For simple metrics: include the referenced measure
        - For derived metrics: include all referenced metrics' dependencies (recursive)
        - Include dependent measures in explore even if they don't have `bi_field: true`
        - Mark auto-included dependent measures as `hidden: yes` in LookML output (override their config)

        Add to `src/dbt_to_lookml/schemas.py`:
        - Add `get_required_measures()` method to `Metric` class to return list of measure names
        - Handle recursive dependency resolution for derived metrics that reference other metrics

        ## Technical Requirements

        - Only applies when `use_bi_field_filter=True`
        - Dependency resolution must be recursive (metric → metric → measure chains)
        - Circular dependency detection (log warning, break cycle)
        - Auto-included measures get `hidden: yes` added to their LookML output
        - If a measure is already marked `bi_field: true`, don't add hidden: yes (respect original config)
        - Track dependency graph for debugging/logging

        ## Testing

        - Unit tests for simple metric dependency tracking (1 measure)
        - Unit tests for derived metric dependency tracking (multiple measures)
        - Unit tests for recursive dependency resolution (metric → metric → measure)
        - Test that dependent measures are auto-included in explore
        - Test that auto-included measures have hidden: yes
        - Test that bi_field: true measures don't get hidden: yes override
        - Test circular dependency detection and warning
        - Integration tests with realistic metric dependency graphs

        Parent: DTL-021
      labels:
        - stack:backend
        - type:feature
        - layer:features
        - priority:high
      status: Refinement

    - title: "Add comprehensive tests for metrics and visibility features"
      description: |
        Create comprehensive test suite covering all metrics support and field visibility features.

        ## Scope

        Add to `src/tests/unit/`:
        - `test_metric_schemas.py`: Schema model tests (Metric, SimpleMetric, DerivedMetric)
        - `test_metric_parser.py`: Parser tests for metrics files
        - `test_hidden_parameter.py`: Tests for hidden parameter on all field types
        - `test_bi_field_filter.py`: Tests for bi_field opt-in filtering
        - `test_metric_dependencies.py`: Tests for dependency resolution

        Add to `src/tests/integration/`:
        - `test_metrics_end_to_end.py`: Full pipeline tests (parse metrics → generate LookML)
        - `test_visibility_end_to_end.py`: Full pipeline tests with hidden/bi_field

        Add to `src/tests/test_golden.py`:
        - Golden tests for metrics LookML output
        - Golden tests for hidden parameter output
        - Golden tests for bi_field filtered explores
        - Golden tests for dependency-resolved explores

        Add test fixtures:
        - `src/tests/fixtures/metrics/complex_dependencies.yml`: Multi-level metric dependencies
        - `src/tests/fixtures/metrics/hidden_fields.yml`: Fields with hidden parameter
        - `src/tests/fixtures/metrics/bi_field_selection.yml`: Fields with bi_field tags

        ## Technical Requirements

        - Achieve 95%+ branch coverage for all new code
        - Test all error paths (malformed metrics, circular dependencies, etc.)
        - Test backward compatibility (existing tests still pass)
        - Use pytest markers: `unit`, `integration`, `golden`
        - Mock filesystem access where appropriate
        - Use temporary directories for file writing tests

        ## Testing

        - Run `make test-coverage` and verify 95%+ coverage
        - Run `make test-full` and verify all tests pass
        - Verify mypy type checking passes
        - Verify no regressions in existing tests

        Parent: DTL-021
      labels:
        - stack:backend
        - type:feature
        - layer:features
        - priority:high
      status: Refinement

    - title: "Update documentation for metrics and visibility support"
      description: |
        Update CLAUDE.md and user-facing documentation to describe metrics support and field visibility features.

        ## Scope

        Update `CLAUDE.md`:
        - Add "Metrics Support" section explaining dbt metrics parsing and LookML conversion
        - Add "Field Visibility Control" section explaining hidden and bi_field parameters
        - Add examples of metrics YAML files
        - Add examples of hidden parameter usage
        - Add examples of bi_field opt-in with dependency resolution
        - Update "Important Implementation Details" with metrics conversion rules
        - Update "Common Pitfalls" with metrics-specific gotchas

        Update `README.md` (if exists):
        - Add metrics support to feature list
        - Add CLI examples with --bi-field-only flag

        Add example files:
        - `examples/metrics/simple_metrics.yml`: Simple metric examples
        - `examples/metrics/derived_metrics.yml`: Derived metric examples
        - `examples/visibility/hidden_fields.yml`: Hidden parameter examples
        - `examples/visibility/bi_field_selection.yml`: bi_field examples

        ## Technical Requirements

        - Follow existing CLAUDE.md structure and formatting
        - Include code examples with proper syntax highlighting
        - Include LookML output examples showing before/after
        - Document configuration precedence (dimension-level > generator > CLI > default)
        - Document backward compatibility guarantees
        - Include troubleshooting section for common issues

        ## Testing

        - Validate all code examples are syntactically correct
        - Verify example YAML files parse successfully
        - Run example commands and verify output matches documentation

        Parent: DTL-021
      labels:
        - stack:backend
        - type:chore
        - layer:features
        - priority:medium
      status: Refinement
