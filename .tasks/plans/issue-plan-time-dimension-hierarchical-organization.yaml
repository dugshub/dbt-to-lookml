epic:
  title: "Epic: Improve Time Dimension Organization in LookML Field Picker"
  description: |
    ## Problem Statement

    Currently, time dimension_groups in generated LookML are organized in a flat list under a generic category (e.g., "Time Periods"), making it difficult to parse when multiple time dimensions exist. For example:

    ```
    Time Dimensions
      DIMENSIONS
        Time Periods
          Rental Created Date
          Rental Created Month
          Rental Created Quarter
          Rental Created Week
          Rental Created Year
          Rental Updated Date
          Rental Updated Month
          Rental Updated Quarter
          Rental Updated Week
          Rental Updated Year
    ```

    This creates a long, flat list where all timeframes from different dimension_groups are mixed together.

    ## Solution Approach

    Implement hierarchical organization using LookML's `group_label` and `group_item_label` parameters to create a nested structure where each dimension_group becomes its own sub-category:

    ```
    Time Dimensions
      Rental Created
        Date
        Month
        Quarter
        Week
        Year
      Rental Updated
        Date
        Month
        Quarter
        Week
        Year
    ```

    This approach:
    - Sets a common `group_label: "Time Dimensions"` on all time dimension_groups
    - Uses each dimension_group's `label` to create sub-categories (e.g., "Rental Created")
    - Optionally uses `group_item_label` to show just the timeframe name without repetition
    - Provides multi-level configuration (dimension metadata > generator parameter > CLI flag > default)

    ## Success Criteria

    - [ ] Time dimension_groups have configurable `group_label` with sensible default ("Time Dimensions")
    - [ ] Each dimension_group creates a sub-category in the field picker based on its label
    - [ ] Timeframes are nested under their parent dimension_group (no flat list)
    - [ ] Configuration supports: dimension-level metadata, generator parameter, CLI flag
    - [ ] Backward compatible (can be disabled or customized)
    - [ ] 95%+ test coverage maintained
    - [ ] Documentation updated with examples and best practices

    ## Sub-Issues

    1. Research and document LookML field organization patterns
    2. Add time dimension group_label configuration schema and CLI support
    3. Implement group_label in dimension_group generation logic
    4. Add optional group_item_label support for cleaner timeframe labels
    5. Update comprehensive test suite for new organization
    6. Update documentation with configuration examples
  labels:
    - stack:backend
    - type:epic
    - priority:medium
  status: Refinement

  children:
    - title: "Research and document LookML field organization patterns"
      description: |
        Conduct research on LookML's field organization parameters and document best practices for time dimension organization.

        ## Scope

        - Research `group_label`, `label`, and `group_item_label` parameters in LookML
        - Document how dimension_group automatically creates field groupings
        - Create examples showing current behavior vs. desired hierarchical organization
        - Document interaction between these parameters for time dimensions
        - Identify configuration precedence rules
        - Create technical design doc for implementation approach

        ## Deliverables

        - Technical design document (can be in issue comments or .tasks/docs/)
        - Code examples showing LookML output before/after
        - Precedence rules documentation

        ## Testing

        - Review LookML official documentation
        - Validate examples against Looker field picker behavior (if possible)

        Parent: Auto-set by /plan:create
      labels:
        - stack:backend
        - type:chore
        - priority:medium
      status: Refinement

    - title: "Add time_dimension_group_label configuration to schemas and CLI"
      description: |
        Add support for configuring the top-level group_label for time dimension_groups through metadata, generator parameters, and CLI flags.

        ## Scope

        - Add `time_dimension_group_label: str | None` field to `ConfigMeta` schema (schemas/config.py)
        - Add `time_dimension_group_label: str | None` parameter to `LookMLGenerator.__init__()` (generators/lookml.py)
        - Add `--time-dimension-group-label TEXT` CLI flag to generate command (__main__.py)
        - Add `--no-time-dimension-group-label` CLI flag to explicitly disable grouping
        - Set default value to "Time Dimensions" for better out-of-box organization
        - Update generator initialization to pass parameter through to dimension generation

        ## Implementation Details

        Schema update (schemas/config.py):
        ```python
        class ConfigMeta(BaseModel):
            # ... existing fields ...
            time_dimension_group_label: str | None = None
        ```

        Generator parameter (generators/lookml.py):
        ```python
        def __init__(
            self,
            # ... existing params ...
            time_dimension_group_label: str | None = None,  # Default "Time Dimensions"
        ):
        ```

        CLI flags (__main__.py):
        ```python
        @click.option(
            "--time-dimension-group-label",
            type=str,
            default=None,
            help="Group label for time dimension_groups (default: 'Time Dimensions')",
        )
        @click.option(
            "--no-time-dimension-group-label",
            is_flag=True,
            help="Disable time dimension group labeling",
        )
        ```

        ## Testing

        - Unit tests for ConfigMeta schema validation
        - Unit tests for LookMLGenerator parameter handling
        - CLI tests for flag parsing
        - Integration test showing parameter flow from CLI → Generator → Schema

        Parent: Auto-set by /plan:create
      labels:
        - stack:backend
        - type:feature
        - priority:high
      status: Refinement

    - title: "Implement group_label in dimension_group generation"
      description: |
        Update the dimension_group generation logic to apply group_label with proper precedence handling.

        ## Scope

        - Modify `Dimension._to_dimension_group_dict()` to accept `default_time_dimension_group_label` parameter
        - Implement precedence logic: dimension meta > generator default > hardcoded default ("Time Dimensions")
        - Apply `group_label` to dimension_group output dictionary
        - Ensure dimension_group's `label` parameter is set for sub-grouping
        - Handle case where user explicitly disables grouping (None or empty string)

        ## Implementation Details

        Update method signature (schemas/semantic_layer.py):
        ```python
        def _to_dimension_group_dict(
            self,
            default_convert_tz: bool | None = None,
            default_time_dimension_group_label: str | None = None,
        ) -> dict[str, Any]:
        ```

        Add precedence logic:
        ```python
        # Determine group_label with three-tier precedence
        group_label = "Time Dimensions"  # Default
        if default_time_dimension_group_label is not None:
            group_label = default_time_dimension_group_label
        if self.config and self.config.meta and self.config.meta.time_dimension_group_label is not None:
            group_label = self.config.meta.time_dimension_group_label

        # Apply group_label if not explicitly disabled
        if group_label:
            result["group_label"] = group_label
        ```

        Update SemanticModel.to_lookml_dict() to pass parameter through:
        ```python
        dim_dict = dim._to_dimension_group_dict(
            default_convert_tz=convert_tz,
            default_time_dimension_group_label=time_dimension_group_label,
        )
        ```

        ## Testing

        - Unit test: dimension_group with meta override
        - Unit test: dimension_group with generator default
        - Unit test: dimension_group with hardcoded default
        - Unit test: dimension_group with grouping explicitly disabled
        - Integration test: full flow with multiple time dimensions

        Parent: Auto-set by /plan:create
      labels:
        - stack:backend
        - type:feature
        - priority:high
      status: Refinement

    - title: "Add group_item_label support for cleaner timeframe labels"
      description: |
        Add optional support for `group_item_label` to customize how individual timeframe fields appear within the grouped section (showing just "Date", "Month", etc. instead of "Rental Created Date", "Rental Created Month").

        ## Scope

        - Add `use_group_item_label: bool` parameter to `LookMLGenerator`
        - Add `--use-group-item-label` CLI flag
        - Implement `group_item_label` generation in `_to_dimension_group_dict()`
        - Use Liquid templating to extract timeframe name from field name
        - Make this optional (disabled by default for backward compatibility)

        ## Implementation Details

        Generator parameter:
        ```python
        def __init__(
            self,
            # ... existing params ...
            use_group_item_label: bool = False,  # Opt-in feature
        ):
        ```

        Liquid template for group_item_label:
        ```python
        if use_group_item_label:
            # Extract timeframe name from generated field name
            # Field format: {dimension_group_name}_{timeframe}
            # We want to show just the timeframe with proper capitalization
            result["group_item_label"] = (
                "{% assign tf = _field._name | remove: '" + self.name + "_' | "
                "replace: '_', ' ' | capitalize %}{{ tf }}"
            )
        ```

        ## Testing

        - Unit test: group_item_label generation when enabled
        - Unit test: no group_item_label when disabled (default)
        - Integration test: verify Liquid template correctness
        - Golden test: verify generated LookML output

        ## Notes

        This feature is optional and disabled by default to maintain backward compatibility. Users can enable it for cleaner field labels if desired.

        Parent: Auto-set by /plan:create
      labels:
        - stack:backend
        - type:feature
        - priority:low
      status: Refinement

    - title: "Update test suite for time dimension organization features"
      description: |
        Comprehensive test coverage for the new time dimension organization features, including unit tests, integration tests, and golden file updates.

        ## Scope

        - Update unit tests for ConfigMeta schema with time_dimension_group_label field
        - Update unit tests for LookMLGenerator with new parameters
        - Add unit tests for Dimension._to_dimension_group_dict() with group_label logic
        - Add integration tests for full generation flow with time dimension grouping
        - Update golden test files (.lkml) to include expected group_label output
        - Add CLI tests for new flags (--time-dimension-group-label, --use-group-item-label)
        - Verify 95%+ branch coverage maintained

        ## Test Cases

        **Unit Tests (test_schemas.py):**
        - ConfigMeta with time_dimension_group_label set
        - ConfigMeta with time_dimension_group_label None (default)

        **Unit Tests (test_lookml_generator.py):**
        - LookMLGenerator with time_dimension_group_label parameter
        - LookMLGenerator with use_group_item_label=True
        - LookMLGenerator with use_group_item_label=False (default)

        **Unit Tests (test_dimension.py or similar):**
        - _to_dimension_group_dict() with meta override for group_label
        - _to_dimension_group_dict() with generator default for group_label
        - _to_dimension_group_dict() with hardcoded default ("Time Dimensions")
        - _to_dimension_group_dict() with grouping disabled (empty string)
        - group_item_label generation when use_group_item_label=True

        **Integration Tests (test_integration.py):**
        - End-to-end generation with multiple time dimensions
        - Verify hierarchical organization in output
        - Verify precedence: dimension meta > generator > default

        **Golden Tests (test_golden.py):**
        - Update expected_*.view.lkml files to include group_label
        - Verify dimension_groups have group_label: "Time Dimensions"
        - Add test case with custom group_label

        **CLI Tests (test_cli.py):**
        - Test --time-dimension-group-label flag
        - Test --no-time-dimension-group-label flag
        - Test --use-group-item-label flag
        - Verify flags pass through to generator

        ## Coverage Target

        - Maintain 95%+ branch coverage for modified modules
        - All new code paths covered by tests
        - Edge cases tested (None, empty string, override scenarios)

        Parent: Auto-set by /plan:create
      labels:
        - stack:backend
        - type:feature
        - priority:high
      status: Refinement

    - title: "Update documentation for time dimension organization"
      description: |
        Update CLAUDE.md and user-facing documentation with comprehensive information about the new time dimension organization features.

        ## Scope

        - Add "Time Dimension Organization" section to CLAUDE.md
        - Document configuration levels and precedence rules
        - Provide before/after examples showing field picker improvements
        - Document CLI flags and usage examples
        - Document metadata configuration in semantic model YAML
        - Add examples to existing "Important Implementation Details" section

        ## Content Structure

        ### Time Dimension Organization (New Section in CLAUDE.md)

        1. **Overview**: Explain the hierarchical organization feature
        2. **Default Behavior**: Document "Time Dimensions" default group_label
        3. **Configuration Levels**: Precedence chain with examples
        4. **CLI Usage**: Examples of flags
        5. **Metadata Override**: YAML examples for dimension-level configuration
        6. **group_item_label**: Optional feature documentation
        7. **LookML Output Examples**: Show generated code
        8. **Field Picker Examples**: Show before/after organization

        ## Examples to Include

        ```yaml
        # Semantic model with custom time dimension grouping
        dimensions:
          - name: created_at
            type: time
            type_params:
              time_granularity: day
            config:
              meta:
                time_dimension_group_label: "Transaction Dates"
        ```

        ```bash
        # CLI usage examples
        dbt-to-lookml generate -i semantic_models/ -o build/lookml/ \
          --time-dimension-group-label "Date Dimensions"

        # Disable grouping
        dbt-to-lookml generate -i semantic_models/ -o build/lookml/ \
          --no-time-dimension-group-label

        # Enable group_item_label for cleaner labels
        dbt-to-lookml generate -i semantic_models/ -o build/lookml/ \
          --use-group-item-label
        ```

        ```lookml
        # Generated LookML output
        dimension_group: rental_created {
          label: "Rental Created"
          group_label: "Time Dimensions"
          type: time
          timeframes: [date, week, month, quarter, year]
          sql: ${TABLE}.rental_created_at ;;
          convert_tz: no
        }
        ```

        ## Testing

        - Verify all code examples are accurate
        - Ensure documentation reflects actual implementation
        - Review for clarity and completeness

        Parent: Auto-set by /plan:create
      labels:
        - stack:backend
        - type:chore
        - priority:medium
      status: Refinement
